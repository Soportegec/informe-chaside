const API_URL = 'https://script.google.com/macros/s/AKfycbzYU1PjjBDZX7o0_chk9tvJ2a9wmWXjRG8pjdqSxFqf4Z9-kM_59ctvonJTQiUPgjr-/exec';
const ETIQUETAS_AREAS = ["Ciencias Exactas y Agrarias", "Humanidades y Ciencias Sociales", "Artes", "Ciencias Sociales y Educación", "Ingeniería y Tecnología", "Administración y Negocios"];
const ETIQUETAS_CORTAS = ["C_Ciencias", "H_Humanidades", "A_Artes", "S_Educacion", "I_Ingenieria", "D_Administracion"];

const selectorColegio = document.getElementById('selector-colegio');
const btnConsultar = document.getElementById('btn-consultar');
const selectorEstudiante = document.getElementById('selector-estudiante');
const informeContainer = document.getElementById('informe-container');
const btnPdfIndividual = document.getElementById('btn-pdf-individual');
const btnPdfMasivo = document.getElementById('btn-pdf-masivo');
const loader = document.getElementById('loader');

let chartInstance = null;
let todosLosDatos = null; // CACHÉ GLOBAL
let colegiosCache = [];
let estudiantesFiltrados = [];

function mostrarLoader(mensaje) { loader.textContent = mensaje; }
function ocultarLoader() { loader.textContent = ''; }

function generarInformeHTML(estudiante) {
    const puntuacionMaxima = Math.max(...estudiante.puntuaciones);
    const indiceMaximo = estudiante.puntuaciones.indexOf(puntuacionMaxima);
    const areaDominanteCorta = ETIQUETAS_CORTAS[indiceMaximo];
    const areaDominante = ETIQUETAS_AREAS[indiceMaximo];
    
    let tablaHTML = '<table><tr><th>Área Vocacional</th><th>Puntuación</th></tr>';
    ETIQUETAS_AREAS.forEach((area, index) => {
        tablaHTML += `<tr><td>${area}</td><td>${estudiante.puntuaciones[index]}</td></tr>`;
    });
    tablaHTML += '</table>';
    
    const descripciones = {
        "C_Ciencias": "Te interesan las ciencias naturales, la investigación científica y el cuidado de la salud.",
        "H_Humanidades": "Te apasiona comprender el comportamiento humano, la sociedad y las cuestiones legales.",
        "A_Artes": "Tienes un perfil creativo y artístico. Te gusta expresarte a través de diferentes medios.",
        "S_Educacion": "Te apasiona enseñar, formar y contribuir al desarrollo de otros.",
        "I_Ingenieria": "Te fascina el diseño, la construcción y la tecnología.",
        "D_Administracion": "Tienes habilidades para la gestión, organización y los negocios."
    };
    
    return `
        <header>
            <h1>INFORME DE ORIENTACIÓN VOCACIONAL</h1>
            <p>Grupo Edúcate Colombia</p>
        </header>
        <div class="info-estudiante">
            <p><strong>Nombre:</strong> ${estudiante.nombre}</p>
            <p><strong>Correo:</strong> ${estudiante.correo}</p>
            <p><strong>DANE:</strong> ${estudiante.dane}</p>
            <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
        </div>
        <div class="resultados">
            <div class="tabla-puntuaciones">${tablaHTML}</div>
            <div class="grafico-container"><canvas id="radarChart"></canvas></div>
        </div>
        <div class="area-dominante">
            <h2>TU ÁREA VOCACIONAL DOMINANTE</h2>
            <p>Tu área de mayor interés es: <span class="area-dominante-nombre">${areaDominante}</span></p>
            <p>Con una puntuación de: <strong>${puntuacionMaxima} de 50</strong></p>
            <p><strong>Descripción:</strong> ${descripciones[areaDominanteCorta]}</p>
        </div>
    `;
}

function dibujarGrafico(puntuaciones) {
    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('radarChart');
    chartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ETIQUETAS_AREAS.map(l => l.split(' ')[0]),
            datasets: [{
                data: puntuaciones,
                fill: true,
                backgroundColor: 'rgba(44, 106, 194, 0.2)',
                borderColor: 'rgb(44, 106, 194)',
                pointBackgroundColor: 'rgb(44, 106, 194)',
            }]
        },
        options: {
            scales: { r: { suggestedMin: 0, suggestedMax: 50 } },
            plugins: { legend: { display: false } }
        }
    });
}

// CARGA INICIAL: Trae TODO de una vez
async function cargarTodosDatos() {
    mostrarLoader('Cargando datos del sistema...');
    try {
        const response = await fetch(`${API_URL}?endpoint=todo`);
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        
        todosLosDatos = result.data;
        colegiosCache = todosLosDatos.colegios;
        
        // Llenar selector de colegios
        selectorColegio.innerHTML = '<option value="">-- Selecciona un Colegio --</option>';
        colegiosCache.forEach(colegio => {
            const option = new Option(colegio.nombre, colegio.dane);
            selectorColegio.appendChild(option);
        });
        
        mostrarLoader('✓ Datos cargados exitosamente');
        setTimeout(ocultarLoader, 1500);
    } catch (error) {
        alert('Error al cargar datos: ' + error.message);
        ocultarLoader();
    }
}

// Filtrar estudiantes localmente (sin llamada a API)
function filtrarEstudiantesPorColegio(dane) {
    return todosLosDatos.estudiantes.filter(est => est.dane == dane);
}

// Buscar informe localmente (sin llamada a API)
function buscarInformeEstudiante(correo) {
    return todosLosDatos.estudiantes.find(est => est.correo == correo);
}

// EVENTOS
document.addEventListener('DOMContentLoaded', cargarTodosDatos);

selectorColegio.addEventListener('change', () => {
    const dane = selectorColegio.value;
    btnConsultar.disabled = !dane;
    selectorEstudiante.innerHTML = '<option value="">-- Consulta primero --</option>';
    selectorEstudiante.disabled = true;
    btnPdfIndividual.disabled = true;
    btnPdfMasivo.disabled = true;
});

btnConsultar.addEventListener('click', () => {
    const dane = selectorColegio.value;
    if (!dane || !todosLosDatos) return;
    
    mostrarLoader('Filtrando estudiantes...');
    
    // Filtrado INSTANTÁNEO (sin API)
    estudiantesFiltrados = filtrarEstudiantesPorColegio(dane);
    
    selectorEstudiante.innerHTML = '<option value="">-- Selecciona un Estudiante --</option>';
    if (estudiantesFiltrados.length === 0) {
        selectorEstudiante.innerHTML = '<option value="">No hay estudiantes</option>';
    } else {
        estudiantesFiltrados.forEach(estudiante => {
            const option = new Option(estudiante.nombre, estudiante.correo);
            selectorEstudiante.appendChild(option);
        });
    }
    
    selectorEstudiante.disabled = false;
    btnPdfMasivo.disabled = estudiantesFiltrados.length === 0;
    ocultarLoader();
});

selectorEstudiante.addEventListener('change', () => {
    const correo = selectorEstudiante.value;
    if (!correo || !todosLosDatos) return;
    
    mostrarLoader('Renderizando informe...');
    
    // Búsqueda INSTANTÁNEA (sin API)
    const estudiante = buscarInformeEstudiante(correo);
    if (estudiante) {
        informeContainer.innerHTML = generarInformeHTML(estudiante);
        dibujarGrafico(estudiante.puntuaciones);
        btnPdfIndividual.disabled = false;
    }
    
    ocultarLoader();
});

// PDFs
window.jsPDF = window.jspdf.jsPDF;

btnPdfIndividual.addEventListener('click', () => {
    const nombreEstudiante = selectorEstudiante.options[selectorEstudiante.selectedIndex].text;
    mostrarLoader('Generando PDF...');
    
    html2canvas(informeContainer).then(canvas => {
        const doc = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'letter' });
        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save(`Informe - ${nombreEstudiante}.pdf`);
        ocultarLoader();
    });
});

btnPdfMasivo.addEventListener('click', async () => {
    if (estudiantesFiltrados.length === 0) return;
    if (!confirm(`Se generará un PDF con ${estudiantesFiltrados.length} informes. ¿Continuar?`)) return;
    
    const doc = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'letter' });
    
    for (let i = 0; i < estudiantesFiltrados.length; i++) {
        const estudiante = estudiantesFiltrados[i];
        mostrarLoader(`Generando PDF masivo (${i + 1} de ${estudiantesFiltrados.length}): ${estudiante.nombre}`);
        
        informeContainer.innerHTML = generarInformeHTML(estudiante);
        dibujarGrafico(estudiante.puntuaciones);
        
        await new Promise(r => setTimeout(r, 300));
        
        const canvas = await html2canvas(informeContainer);
        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        if (i > 0) doc.addPage();
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    }
    
    const nombreColegio = selectorColegio.options[selectorColegio.selectedIndex].text;
    doc.save(`Informe Compilado - ${nombreColegio}.pdf`);
    ocultarLoader();
    alert('¡Generación masiva completada!');
});
