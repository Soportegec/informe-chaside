<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Informes Vocacionales</title>
    <!-- Librerías Externas -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --color-azul: #1E3A5F; --color-fondo: #F0F2F5; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--color-fondo); color: #333; } /* Fondo de la aplicación */
        .app-container { max-width: 1200px; margin: 30px auto; background: white; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .controles { display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; background-color: var(--color-fondo); border-radius: 8px; margin-bottom: 30px; align-items: flex-end; }
        .control-grupo { display: flex; flex-direction: column; }
        .control-grupo label { font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #555; }
        select, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; background-color: white; }
        button { cursor: pointer; background-color: var(--color-azul); color: white; border: none; font-weight: 600; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #12233a; }
        #loader { font-size: 14px; color: #555; margin-left: 10px; font-weight: 500; }

        /* Estilos del Prototipo para el Contenedor del Informe (dentro de #informe-container) */
        #informe-visual { width: 100%; height: 794px; display: flex; flex-direction: column; box-sizing: border-box; border: 1px solid #ccc; }
        #informe-visual header { background-color: #46B4A8; color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
        #informe-visual .logo { width: 250px; height: auto; }
        #informe-visual .titulo-informe h1 { margin: 0; font-size: 24px; font-weight: 700; }
        #informe-visual .titulo-informe p { margin: 5px 0 0; font-size: 14px; }
        #informe-visual .info-estudiante { display: flex; justify-content: space-between; padding: 15px 40px; }
        #informe-visual .info-estudiante p { margin: 4px 0; font-size: 13px; }
        #informe-visual .info-estudiante strong { font-weight: 600; }
        #informe-visual main { display: flex; flex: 1; padding: 0 40px; gap: 40px; overflow: hidden; }
        #informe-visual .columna-izquierda, #informe-visual .columna-derecha { display: flex; flex-direction: column; flex-basis: 50%; }
        #informe-visual .seccion-titulo { background-color: var(--color-azul); color: white; padding: 8px 12px; font-weight: 600; font-size: 14px; border-radius: 4px 4px 0 0; }
        #informe-visual .seccion-contenido { padding: 12px; border: 1px solid #E0E0E0; border-top: none; border-radius: 0 0 4px 4px; }
        #informe-visual table { width: 100%; border-collapse: collapse; font-size: 13px; }
        #informe-visual th, #informe-visual td { text-align: left; padding: 9px 12px; }
        #informe-visual th { background-color: var(--color-azul); color: white; font-weight: 600; }
        #informe-visual td:last-child { text-align: left; font-weight: 500; }
        #informe-visual tbody tr { background-color: #F0F2F5; }
        #informe-visual .area-dominante, #informe-visual .descripcion { margin-top: 15px; }
        #informe-visual .area-dominante p { font-size: 13px; line-height: 1.5; margin: 0; }
        #informe-visual .descripcion p { font-size: 13px; line-height: 1.5; margin: 0; text-align: left; } /* Justificado eliminado de HTML */
        #informe-visual .area-dominante strong { font-weight: 700; }
        #informe-visual .grafico-container { height: 330px; display: flex; align-items: center; justify-content: center; border: 1px solid #E0E0E0; border-radius: 4px; padding: 10px; margin-bottom: 15px; }
        #informe-visual .carreras-sugeridas ul { list-style-type: none; padding-left: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 8px 20px; font-size: 13px; }
        #informe-visual .carreras-sugeridas ul li { padding-left: 1em; }
        #informe-visual .carreras-sugeridas ul li::before { content: '•'; color: var(--color-azul); font-weight: bold; display: inline-block; width: 1em; margin-left: -1em; }
        #informe-visual footer { background-color: var(--color-azul); color: white; padding: 15px 40px; text-align: center; font-size: 12px; line-height: 1.5; }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #1E3A5F; margin: 30px 0 20px 0; font-size: 28px;">Sistema de Orientación Vocacional - TEST CHASIDE</h1>
    <div class="app-container">
        <div class="controles">
            <div class="control-grupo"><label for="selector-colegio">1. Seleccionar Colegio:</label><select id="selector-colegio"><option value="">Cargando colegios...</option></select></div>
            <div class="control-grupo"><button id="btn-consultar" disabled>2. Consultar Estudiantes</button></div>
            <div class="control-grupo"><label for="selector-estudiante">3. Seleccionar Estudiante:</label><select id="selector-estudiante" disabled><option value="">-- Consulta primero --</option></select></div>
            <!-- Botones Actualizados y Nuevos -->
            <div class="control-grupo"><button id="btn-pdf-unico" disabled>Informe PDF Único</button></div>
            <div class="control-grupo"><button id="btn-pdf-compilado" disabled>Informe PDF Compilado</button></div>
            <div class="control-grupo"><button id="btn-pdf-individual-multiple" disabled>Informe PDF Individual</button></div>
            <div class="control-grupo"><button id="btn-pdf-grupal" disabled>Informe Grupal</button></div>
            <div id="loader"></div>
        </div>
        <div id="informe-container"></div>
    </div>

    <script>
        // --- CONSTANTES Y SELECTORES GLOBALES ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbyPofXK90pg18IegH5EAkW4uY3MRs2X3e3IkCCdsIKJ1d_WWMH6EFr-dIvUgbBxYME/exec';
        const ETIQUETAS_AREAS = ["Ciencias Exactas y Agrarias", "Humanidades y Ciencias Sociales", "Artes", "Ciencias Sociales y Educación", "Ingeniería y Tecnología", "Administración y Negocios"];
        const ETIQUETAS_CORTAS = ["C_Ciencias", "H_Humanidades", "A_Artes", "S_Educacion", "I_Ingenieria", "D_Administracion"]; // Usadas para lógica grupal
        const ETIQUETAS_CORTAS_GRAFICO = ["Ciencias", "Humanidades", "Artes", "Educación", "Ingeniería", "Administración"];
        // ¡CAMBIO IMPORTANTE! PEGA TU CÓDIGO BASE64 AQUÍ
        const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUUAAACHCAYAAACBI0tWAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAydpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDkuMS1jMDAxIDc5LjE0NjI4OTk3NzcsIDIwMjMvMDYvMjUtMjM6NTc6MTQgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludaxAAAAASUVORK5CYII='; // <-- ¡Pega tu código Base64 del logo aquí!

        const selectorColegio = document.getElementById('selector-colegio');
        const btnConsultar = document.getElementById('btn-consultar');
        const selectorEstudiante = document.getElementById('selector-estudiante');
        const informeContainer = document.getElementById('informe-container');
        const btnPdfUnico = document.getElementById('btn-pdf-unico');
        const btnPdfCompilado = document.getElementById('btn-pdf-compilado');
        const btnPdfIndividualMultiple = document.getElementById('btn-pdf-individual-multiple'); // Nuevo
        const btnPdfGrupal = document.getElementById('btn-pdf-grupal'); // Nuevo
        const loader = document.getElementById('loader');

        let chartInstance = null;
        let todosLosDatos = null;
        let estudiantesFiltrados = [];

        // --- FUNCIONES AUXILIARES ---
        function mostrarLoader(mensaje) { loader.textContent = mensaje; }
        function ocultarLoader() { loader.textContent = ''; }
        
        // --- LÓGICA DE CARGA DE DATOS ---
        async function cargarDatosIniciales() {
            mostrarLoader('Cargando datos del sistema...');
            try {
                const response = await fetch(`${API_URL}?endpoint=todo`);
                if (!response.ok) { throw new Error(`Error de red: ${response.statusText}`); }
                const json = await response.json();
                if (json.error) { throw new Error(json.error); }
                todosLosDatos = json.data;
                if (!todosLosDatos || !todosLosDatos.colegios) { throw new Error("La respuesta de la API no contiene los datos esperados."); }

                selectorColegio.innerHTML = '<option value="">-- Selecciona un Colegio --</option>';
                todosLosDatos.colegios.forEach(colegio => selectorColegio.add(new Option(colegio.nombre, colegio.dane)));

                mostrarLoader('✓ Datos cargados exitosamente');
                setTimeout(ocultarLoader, 1500);
            } catch (error) {
                alert('Error al cargar datos: ' + error.message);
                ocultarLoader();
            }
        }
        
        // --- FUNCIÓN DE RENDERIZADO EN PANTALLA ---
        function renderizarInformeEnPantalla(estudiante, colegioNombre) {
            if (chartInstance) chartInstance.destroy();
            const areaDominante = ETIQUETAS_AREAS[estudiante.puntuaciones.indexOf(estudiante.puntuacionMaxima)];
            const filasTablaHTML = ETIQUETAS_AREAS.map((area, i) => `<tr><td>${area}</td><td>${estudiante.puntuaciones[i]}</td></tr>`).join('');
            const carrerasHTML = estudiante.carreras.map(carrera => `<li>${carrera}</li>`).join('');

            informeContainer.innerHTML = `
                <div id="informe-visual">
                    <header>
                        <img src="${LOGO_BASE64}" alt="Logo Grupo Edúcate" class="logo">
                        <div class="titulo-informe"><h1>INFORME DE ORIENTACIÓN VOCACIONAL</h1><p>Colegio: ${colegioNombre}</p></div>
                    </header>
                    <section class="info-estudiante">
                        <div><p><strong>Nombre del estudiante:</strong> ${estudiante.nombre}</p><p><strong>Correo electrónico:</strong> ${estudiante.correo}</p></div>
                        <div><p><strong>DANE Colegio:</strong> ${estudiante.dane}</p><p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p></div>
                    </section>
                    <main>
                        <div class="columna-izquierda">
                            <table><thead><tr><th>Área vocacional</th><th>Puntuación</th></tr></thead><tbody>${filasTablaHTML}</tbody></table>
                            <div class="area-dominante">
                                <div class="seccion-titulo">Tu área vocacional dominante:</div>
                                <div class="seccion-contenido">
                                    <p>Área de mayor interés: <strong>${areaDominante}</strong></p>
                                    <p>Puntuación obtenida: <strong>${estudiante.puntuacionMaxima}</strong> de 50</p>
                                </div>
                            </div>
                            <div class="descripcion"><div class="seccion-titulo">Descripción:</div><div class="seccion-contenido"><p>${estudiante.descripcion}</p></div></div>
                        </div>
                        <div class="columna-derecha">
                            <div class="grafico-container"><canvas id="radarChart"></canvas></div>
                            <div class="carreras-sugeridas"><div class="seccion-titulo">Carreras sugeridas:</div><div class="seccion-contenido"><ul>${carrerasHTML}</ul></div></div>
                        </div>
                    </main>
                    <footer>En Grupo Edúcate Colombia creemos que la vocación es el punto de encuentro entre lo que amas y lo que haces bien. Acompañamos a cada estudiante en el descubrimiento de sus fortalezas e intereses, guiándolo hacia un futuro donde pueda crecer con pasión y propósito.</footer>
                </div>
            `;
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels: ETIQUETAS_CORTAS_GRAFICO, datasets: [{ data: estudiante.puntuaciones, fill: true, backgroundColor: 'rgba(30, 58, 95, 0.3)', borderColor: 'rgb(30, 58, 95)', pointBackgroundColor: 'rgb(30, 58, 95)' }] },
                options: { maintainAspectRatio: false, animation: false, scales: { r: { suggestedMin: 0, suggestedMax: 50, grid: { color: '#ddd' }, pointLabels: { font: { size: 12, family: 'Montserrat' } } } }, plugins: { legend: { display: false } } }
            });
        }
        
        // --- MOTOR DE GENERACIÓN DE PDF INDIVIDUAL ---
        window.jsPDF = window.jspdf.jsPDF;

        function generarPaginaPdf(doc, estudiante, colegioNombre) {
            const areaDominante = ETIQUETAS_AREAS[estudiante.puntuaciones.indexOf(estudiante.puntuacionMaxima)];
            
            // Header
            doc.setFillColor('#46B4A8'); // Color verde
            doc.rect(0, 0, doc.internal.pageSize.getWidth(), 80, 'F');
            
            // Logo
            if (LOGO_BASE64) { doc.addImage(LOGO_BASE64, 'PNG', 40, 15, 180, 50); } // x, y, width, height (restaurado)
            
            doc.setTextColor('white');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text('INFORME DE ORIENTACIÓN VOCACIONAL', doc.internal.pageSize.getWidth() - 40, 40, { align: 'right' }); // Título sin "TEST CHASIDE"
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.text(`Colegio: ${colegioNombre}`, doc.internal.pageSize.getWidth() - 40, 60, { align: 'right' });

            // Info Estudiante
            doc.setTextColor('#333'); doc.setFontSize(11); doc.setFont('helvetica', 'bold');
            doc.text('Nombre del estudiante:', 40, 110); doc.text('Correo electrónico:', 40, 125);
            doc.text('DANE Colegio:', 550, 110); doc.text('Fecha:', 550, 125);
            doc.setFont('helvetica', 'normal');
            doc.text(estudiante.nombre, 180, 110); doc.text(estudiante.correo, 180, 125);
            doc.text(String(estudiante.dane), 650, 110); doc.text(new Date().toLocaleDateString('es-ES'), 650, 125);
            
            // Columna Izquierda - Tabla
            const tablaBody = ETIQUETAS_AREAS.map((area, i) => [area, estudiante.puntuaciones[i]]);
            doc.autoTable({
                startY: 150, head: [['Área vocacional', 'Puntuación']], body: tablaBody,
                headStyles: { fillColor: '#1E3A5F', font: 'helvetica', fontStyle: 'bold' },
                bodyStyles: { font: 'helvetica', fontSize: 10 },
                columnStyles: { 0: { cellWidth: 280 }, 1: { cellWidth: 70, halign: 'left' } },
                margin: { left: 40 }
            });
            let finalY = doc.autoTable.previous.finalY + 20;

            doc.setFillColor('#1E3A5F'); doc.roundedRect(40, finalY, 350, 22, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text('Tu área vocacional dominante:', 50, finalY + 15);
            doc.setDrawColor('#E0E0E0'); doc.roundedRect(40, finalY + 22, 350, 45, 3, 3, 'D'); 
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(`Área de mayor interés: `, 50, finalY + 38);
            doc.setFont('helvetica', 'bold'); doc.text(areaDominante, 155, finalY + 38);
            doc.setFont('helvetica', 'normal');
            doc.text(`Puntuación obtenida: `, 50, finalY + 53);
            doc.setFont('helvetica', 'bold'); doc.text(`${estudiante.puntuacionMaxima} de 50`, 155, finalY + 53);
            finalY += (22 + 45 + 10);

            doc.setFillColor('#1E3A5F'); doc.roundedRect(40, finalY, 350, 22, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text('Descripción:', 50, finalY + 15);
            const descLines = doc.splitTextToSize(estudiante.descripcion, 330);
            const descHeight = descLines.length * 12 + 15;
            doc.setDrawColor('#E0E0E0'); doc.roundedRect(40, finalY + 22, 350, descHeight, 3, 3, 'D');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(descLines, 50, finalY + 37, { align: 'justify', maxWidth: 330 }); // Justificado en PDF

            const chartCanvas = document.getElementById('radarChart');
            const ctx = chartCanvas.getContext('2d');
            ctx.save(); ctx.globalCompositeOperation = 'destination-over'; ctx.fillStyle = 'white'; ctx.fillRect(0, 0, chartCanvas.width, chartCanvas.height); ctx.restore();
            const chartImage = chartCanvas.toDataURL('image/jpeg', 0.8);
            doc.setDrawColor('#E0E0E0');
            doc.roundedRect(430, 150, 350, 250, 3, 3, 'D');
            doc.addImage(chartImage, 'JPEG', 435, 155, 340, 240);
            
            let startYCarreras = 430;
            doc.setFillColor('#1E3A5F'); doc.roundedRect(430, startYCarreras, 350, 22, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text('Carreras sugeridas:', 440, startYCarreras + 15);
            const carrerasHeight = Math.ceil(estudiante.carreras.length / 2) * 15 + 15;
            doc.setDrawColor('#E0E0E0'); doc.roundedRect(430, startYCarreras + 22, 350, carrerasHeight, 3, 3, 'D');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            estudiante.carreras.forEach((carrera, index) => {
                const x = (index % 2 === 0) ? 450 : 610;
                const y = startYCarreras + 40 + Math.floor(index / 2) * 15;
                doc.text(`• ${carrera}`, x, y);
            });

            doc.setFillColor('#1E3A5F');
            doc.rect(0, doc.internal.pageSize.getHeight() - 60, doc.internal.pageSize.getWidth(), 60, 'F');
            doc.setTextColor('white'); doc.setFontSize(9);
            const footerText = "En Grupo Edúcate Colombia creemos que la vocación es el punto de encuentro entre lo que amas y lo que haces bien. Acompañamos a cada estudiante en el descubrimiento de sus fortalezas e intereses, guiándolo hacia un futuro donde pueda crecer con pasión y pasión y propósito."; // Corregido typo
            doc.text(footerText, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 35, { align: 'center', maxWidth: 700 });
        }

        // --- ¡NUEVO! LÓGICA Y GENERACIÓN DE PDF GRUPAL ---
        function analizarDatosGrupales() {
            const totalEstudiantes = estudiantesFiltrados.length;
            const distribucion = {};
            const promedios = new Array(ETIQUETAS_AREAS.length).fill(0);

            ETIQUETAS_CORTAS.forEach((key, index) => {
                distribucion[key] = { nombre: ETIQUETAS_CORTAS_GRAFICO[index], cantidad: 0 };
            });

            for (const estudiante of estudiantesFiltrados) {
                if (estudiante.areaDominanteCorta && distribucion[estudiante.areaDominanteCorta]) {
                    distribucion[estudiante.areaDominanteCorta].cantidad++;
                }
                estudiante.puntuaciones.forEach((p, i) => promedios[i] += p);
            }

            const promediosFinales = promedios.map(total => Math.round(total / totalEstudiantes));
            const distribucionOrdenada = Object.values(distribucion).sort((a, b) => b.cantidad - a.cantidad);

            return {
                totalEstudiantes,
                distribucion: distribucionOrdenada,
                promedios: promediosFinales
            };
        }

        async function generarPdfGrupal(doc, datosGrupales, colegioNombre) {
            doc.setFillColor('#46B4A8'); doc.rect(0, 0, doc.internal.pageSize.getWidth(), 80, 'F');
            if (LOGO_BASE64) { doc.addImage(LOGO_BASE64, 'PNG', 40, 15, 180, 50); }
            doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(20);
            doc.text('INFORME VOCACIONAL GRUPAL', doc.internal.pageSize.getWidth() - 40, 40, { align: 'right' });
            doc.setFont('helvetica', 'normal'); doc.setFontSize(12);
            doc.text(`Colegio: ${colegioNombre}`, doc.internal.pageSize.getWidth() - 40, 60, { align: 'right' });
            doc.setTextColor('#333');
            doc.text(`Total de Estudiantes Evaluados: ${datosGrupales.totalEstudiantes}`, 40, 110);

            // Sección 1: Distribución de Áreas Dominantes (Gráfico de Barras)
            doc.setFont('helvetica', 'bold'); doc.setFontSize(14); doc.setTextColor('#1E3A5F');
            doc.text('Distribución de Áreas Vocacionales Dominantes', 40, 150);

            const barCanvas = document.createElement('canvas');
            barCanvas.width = 700;
            barCanvas.height = 400;
            const barCtx = barCanvas.getContext('2d');
            barCtx.fillStyle = 'white'; barCtx.fillRect(0, 0, barCanvas.width, barCanvas.height);

            const barChart = new Chart(barCtx, {
                type: 'bar',
                data: { labels: datosGrupales.distribucion.map(d => d.nombre), datasets: [{ label: 'N° de Estudiantes', data: datosGrupales.distribucion.map(d => d.cantidad), backgroundColor: '#1E3A5F' }] },
                options: {
                    indexAxis: 'y', animation: false, plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { precision: 0 } },
                        y: { ticks: { font: { size: 12, family: 'Montserrat' } } }
                    }
                }
            });
            await new Promise(r => setTimeout(r, 200));
            const barChartImage = barCanvas.toDataURL('image/jpeg', 0.8);
            doc.addImage(barChartImage, 'JPEG', 40, 170, 350, 180);
            barChart.destroy();

            // Sección 2: Perfil Vocacional Promedio (Gráfico de Radar)
            doc.setFont('helvetica', 'bold'); doc.setFontSize(14); doc.setTextColor('#1E3A5F');
            doc.text('Perfil Vocacional Promedio del Grupo', 430, 150);
            
            const radarCanvas = document.createElement('canvas');
            radarCanvas.width = 700;
            radarCanvas.height = 400;
            const radarCtx = radarCanvas.getContext('2d');
            radarCtx.fillStyle = 'white'; radarCtx.fillRect(0, 0, radarCanvas.width, radarCanvas.height);

            const radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: { labels: ETIQUETAS_CORTAS_GRAFICO, datasets: [{ data: datosGrupales.promedios, fill: true, backgroundColor: 'rgba(30, 58, 95, 0.3)', borderColor: 'rgb(30, 58, 95)' }] },
                options: { animation: false, scales: { r: { suggestedMin: 0, suggestedMax: 50, pointLabels: { font: { size: 12, family: 'Montserrat' } } } }, plugins: { legend: { display: false } } }
            });
            await new Promise(r => setTimeout(r, 200));
            const radarChartImage = radarCanvas.toDataURL('image/jpeg', 0.8);
            doc.addImage(radarChartImage, 'JPEG', 430, 170, 350, 280);
            radarChart.destroy();

            // Sección 3: Tabla de Datos Agregados
            doc.autoTable({
                startY: doc.internal.pageSize.getHeight() / 2 + 50,
                head: [['Área Vocacional', 'N° de Estudiantes', 'Puntuación Promedio']],
                body: ETIQUETAS_CORTAS_GRAFICO.map((nombre, i) => {
                    const areaDist = datosGrupales.distribucion.find(d => d.nombre === nombre);
                    return [nombre, areaDist ? areaDist.cantidad : 0, datosGrupales.promedios[i]];
                }),
                headStyles: { fillColor: '#1E3A5F', font: 'helvetica', fontStyle: 'bold' },
                bodyStyles: { font: 'helvetica', fontSize: 10 },
                columnStyles: { 1: { halign: 'center' }, 2: { halign: 'center' } },
                margin: { left: 40, right: 40 },
                tableWidth: 'auto'
            });

            // Footer
            doc.setFillColor('#1E3A5F');
            doc.rect(0, doc.internal.pageSize.getHeight() - 60, doc.internal.pageSize.getWidth(), 60, 'F');
            doc.setTextColor('white'); doc.setFontSize(9);
            const footerText = `Este informe presenta un análisis agregado de las tendencias vocacionales del grupo y no reemplaza la orientación individual de cada estudiante.`;
            doc.text(footerText, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 35, { align: 'center', maxWidth: 700 });

            document.body.removeChild(tempCanvas); // Eliminar el canvas temporal
            doc.save(`Informe Grupal - ${colegioNombre}.pdf`);
            ocultarLoader();
        });


        // --- EVENTOS DE LA UI ---
        document.addEventListener('DOMContentLoaded', cargarDatosIniciales);
        
        selectorColegio.addEventListener('change', () => {
            const hasSelection = !!selectorColegio.value;
            btnConsultar.disabled = !hasSelection;
            selectorEstudiante.innerHTML = '<option value="">-- Consulta primero --</option>';
            selectorEstudiante.disabled = true;
            btnPdfUnico.disabled = true;
            btnPdfCompilado.disabled = true;
            btnPdfIndividualMultiple.disabled = true; // Deshabilitar nuevo botón
            btnPdfGrupal.disabled = true; // Deshabilitar nuevo botón
            informeContainer.innerHTML = '';
        });

        btnConsultar.addEventListener('click', () => {
            const dane = selectorColegio.value;
            if (!dane) return;
            estudiantesFiltrados = todosLosDatos.estudiantes.filter(est => est.dane == dane);
            selectorEstudiante.innerHTML = '<option value="">-- Selecciona un Estudiante --</option>';
            const hasStudents = estudiantesFiltrados.length > 0;
            if (hasStudents) {
                estudiantesFiltrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
                estudiantesFiltrados.forEach(est => selectorEstudiante.add(new Option(est.nombre, est.correo)));
                selectorEstudiante.disabled = false;
                btnPdfCompilado.disabled = false;
                btnPdfIndividualMultiple.disabled = false; // Habilitar si hay estudiantes
                btnPdfGrupal.disabled = false; // Habilitar si hay estudiantes
            } else {
                selectorEstudiante.innerHTML = '<option value="">No hay estudiantes</option>';
            }
        });

        selectorEstudiante.addEventListener('change', () => {
            const correo = selectorEstudiante.value;
            btnPdfUnico.disabled = !correo; // Habilitar/Deshabilitar según selección de estudiante
            if (correo) {
                const estudiante = todosLosDatos.estudiantes.find(est => est.correo === correo);
                const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
                renderizarInformeEnPantalla(estudiante, colegioNombre);
            }
        });

        // Evento para "Informe PDF Único" (antes Descargar PDF)
        btnPdfUnico.addEventListener('click', async () => {
            const correo = selectorEstudiante.value;
            if (!correo) return;
            mostrarLoader('Generando PDF Único...');
            const estudiante = todosLosDatos.estudiantes.find(est => est.correo === correo);
            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
            
            renderizarInformeEnPantalla(estudiante, colegioNombre);
            await new Promise(r => setTimeout(r, 150));

            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
            generarPaginaPdf(doc, estudiante, colegioNombre);
            doc.save(`Informe - ${estudiante.nombre}.pdf`);
            ocultarLoader();
        });

        // Evento para "Informe PDF Compilado" (antes Descarga Masiva)
        btnPdfCompilado.addEventListener('click', async () => {
            if (estudiantesFiltrados.length === 0) return;
            if (!confirm(`Se generará un PDF compilado con ${estudiantesFiltrados.length} informes. ¿Continuar?`)) return;

            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });

            for (let i = 0; i < estudiantesFiltrados.length; i++) {
                const estudiante = estudiantesFiltrados[i];
                mostrarLoader(`Generando compilado (${i + 1}/${estudiantesFiltrados.length}): ${estudiante.nombre}`);
                
                renderizarInformeEnPantalla(estudiante, colegioNombre);
                await new Promise(r => setTimeout(r, 150));

                if (i > 0) doc.addPage();
                generarPaginaPdf(doc, estudiante, colegioNombre);
            }

            doc.save(`Informes Compilados - ${colegioNombre}.pdf`);
            ocultarLoader();
            alert('¡Generación compilada completada!');
        });

        // ¡NUEVO EVENTO! Para "Informe PDF Individual" (descarga múltiples archivos)
        btnPdfIndividualMultiple.addEventListener('click', async () => {
            if (estudiantesFiltrados.length === 0) return;
            if (!confirm(`Se generarán ${estudiantesFiltrados.length} archivos PDF individuales. ¿Continuar?`)) return;

            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;

            for (let i = 0; i < estudiantesFiltrados.length; i++) {
                const estudiante = estudiantesFiltrados[i];
                mostrarLoader(`Generando individual (${i + 1}/${estudiantesFiltrados.length}): ${estudiante.nombre}`);
                
                renderizarInformeEnPantalla(estudiante, colegioNombre);
                await new Promise(r => setTimeout(r, 150));

                const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
                generarPaginaPdf(doc, estudiante, colegioNombre);
                doc.save(`Informe - ${estudiante.nombre}.pdf`);
            }
            ocultarLoader();
            alert('¡Generación de PDFs individuales completada!');
        });


        // ¡NUEVO EVENTO! Para "Informe Grupal"
        btnPdfGrupal.addEventListener('click', async () => {
            if (estudiantesFiltrados.length === 0) return;
            mostrarLoader('Analizando y generando Informe Grupal...');
            
            const datosGrupales = analizarDatosGrupales();
            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
            
            // Crear un canvas temporal para los gráficos grupales.
            // Es importante que esté en el DOM para que Chart.js lo dibuje,
            // pero lo eliminaremos al final.
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 800; 
            tempCanvas.height = 500;
            document.body.appendChild(tempCanvas); 
            
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
            
            // Header
            doc.setFillColor('#46B4A8'); doc.rect(0, 0, doc.internal.pageSize.getWidth(), 80, 'F');
            if (LOGO_BASE64) { doc.addImage(LOGO_BASE64, 'PNG', 40, 15, 180, 50); }
            doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(20);
            doc.text('INFORME VOCACIONAL GRUPAL', doc.internal.pageSize.getWidth() - 40, 40, { align: 'right' });
            doc.setFont('helvetica', 'normal'); doc.setFontSize(12);
            doc.text(`Colegio: ${colegioNombre}`, doc.internal.pageSize.getWidth() - 40, 60, { align: 'right' });
            doc.setTextColor('#333');
            doc.text(`Total de Estudiantes Evaluados: ${datosGrupales.totalEstudiantes}`, 40, 110);

            // --- SECCIÓN 1: DISTRIBUCIÓN DE ÁREAS DOMINANTES (Gráfico de Barras) ---
            doc.setFont('helvetica', 'bold'); doc.setFontSize(14); doc.setTextColor('#1E3A5F');
            doc.text('Distribución de Áreas Vocacionales Dominantes', 40, 150);

            const barCtx = tempCanvas.getContext('2d');
            barCtx.fillStyle = 'white'; barCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); // Fondo blanco
            const barChart = new Chart(barCtx, {
                type: 'bar',
                data: { labels: datosGrupales.distribucion.map(d => d.nombre), datasets: [{ label: 'N° de Estudiantes', data: datosGrupales.distribucion.map(d => d.cantidad), backgroundColor: '#1E3A5F' }] },
                options: { indexAxis: 'y', animation: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { precision: 0 } }, y: { ticks: { font: { size: 12, family: 'Montserrat' } } } } }
            });
            await new Promise(r => setTimeout(r, 200)); // Esperar a que se dibuje el gráfico
            const barChartImage = tempCanvas.toDataURL('image/jpeg', 0.8);
            doc.addImage(barChartImage, 'JPEG', 40, 170, 350, 180); // Ajustar tamaño para que quepa bien
            barChart.destroy(); // Limpiar el gráfico temporal

            // --- SECCIÓN 2: PERFIL VOCACIONAL PROMEDIO (Gráfico de Radar) ---
            doc.setFont('helvetica', 'bold'); doc.setFontSize(14); doc.setTextColor('#1E3A5F');
            doc.text('Perfil Vocacional Promedio del Grupo', 430, 150);
            
            const radarCtx = tempCanvas.getContext('2d');
            radarCtx.fillStyle = 'white'; radarCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); // Fondo blanco
            const radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: { labels: ETIQUETAS_CORTAS_GRAFICO, datasets: [{ data: datosGrupales.promedios, fill: true, backgroundColor: 'rgba(30, 58, 95, 0.3)', borderColor: 'rgb(30, 58, 95)' }] },
                options: { animation: false, scales: { r: { suggestedMin: 0, suggestedMax: 50, pointLabels: { font: { size: 12, family: 'Montserrat' } } } }, plugins: { legend: { display: false } } }
            });
            await new Promise(r => setTimeout(r, 200)); // Esperar a que se dibuje el gráfico
            const radarChartImage = tempCanvas.toDataURL('image/jpeg', 0.8);
            doc.addImage(radarChartImage, 'JPEG', 430, 170, 350, 280);
            radarChart.destroy(); // Limpiar el gráfico temporal

            // Sección 3: Tabla de Datos Agregados
            doc.autoTable({
                startY: doc.internal.pageSize.getHeight() / 2 + 50,
                head: [['Área Vocacional', 'N° de Estudiantes', 'Puntuación Promedio']],
                body: ETIQUETAS_CORTAS_GRAFICO.map((nombre, i) => {
                    const areaDist = datosGrupales.distribucion.find(d => d.nombre === nombre);
                    return [nombre, areaDist ? areaDist.cantidad : 0, datosGrupales.promedios[i]];
                }),
                headStyles: { fillColor: '#1E3A5F', font: 'helvetica', fontStyle: 'bold' },
                bodyStyles: { font: 'helvetica', fontSize: 10 },
                columnStyles: { 1: { halign: 'center' }, 2: { halign: 'center' } },
                margin: { left: 40, right: 40 },
                tableWidth: 'auto'
            });

            // Footer
            doc.setFillColor('#1E3A5F');
            doc.rect(0, doc.internal.pageSize.getHeight() - 60, doc.internal.pageSize.getWidth(), 60, 'F');
            doc.setTextColor('white'); doc.setFontSize(9);
            const footerText = `Este informe presenta un análisis agregado de las tendencias vocacionales del grupo y no reemplaza la orientación individual de cada estudiante.`;
            doc.text(footerText, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 35, { align: 'center', maxWidth: 700 });

            document.body.removeChild(tempCanvas); // Eliminar el canvas temporal del DOM
            doc.save(`Informe Grupal - ${colegioNombre}.pdf`);
            ocultarLoader();
        });
    </script>
</body>
</html>
