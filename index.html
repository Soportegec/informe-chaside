<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Informes Vocacionales</title>
    <!-- Librerías para gráficos y PDFs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .controles { display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; background-color: #eef2f5; border-radius: 8px; margin-bottom: 30px; align-items: flex-end; }
        .control-grupo { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #555; }
        select, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; background-color: white; }
        button { cursor: pointer; background-color: #2c6ac2; color: white; border: none; font-weight: 600; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #235499; }
        .btn-secundario { background-color: #6c757d; }
        .btn-secundario:hover:not(:disabled) { background-color: #5a6268; }
        #loader { font-size: 14px; color: #555; margin-left: 10px; }
        #informe-container { border: 1px solid #ddd; padding: 30px; border-radius: 8px; min-height: 600px; }
        header { text-align: center; margin-bottom: 40px; }
        header h1 { margin: 0; font-size: 24px; }
        header p { margin: 5px 0 0; color: #777; }
        .info-estudiante, .area-dominante { margin-bottom: 40px; }
        .info-estudiante p, .area-dominante p { margin: 8px 0; font-size: 15px; }
        .info-estudiante strong { min-width: 150px; display: inline-block; }
        .resultados { display: flex; gap: 40px; margin-bottom: 40px; align-items: flex-start; }
        .tabla-puntuaciones { flex: 1; }
        .grafico-container { flex: 1; max-width: 400px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px 8px; border-bottom: 1px solid #eee; }
        th { font-size: 14px; color: #555; }
        .area-dominante h2 { font-size: 20px; }
        .area-dominante-nombre { font-size: 22px; font-weight: 700; color: #2c6ac2; }
        @media print { body { background-color: white; padding: 0; margin: 0; } .container { box-shadow: none; border: none; padding: 0; } .controles { display: none; } @page { size: letter landscape; margin: 20px; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="controles">
            <div class="control-grupo">
                <label for="selector-colegio">1. Seleccionar Colegio:</label>
                <select id="selector-colegio"><option value="">Cargando colegios...</option></select>
            </div>
            <div class="control-grupo">
                <button id="btn-consultar" disabled>2. Consultar Estudiantes</button>
            </div>
            <div class="control-grupo">
                <label for="selector-estudiante">3. Seleccionar Estudiante:</label>
                <select id="selector-estudiante" disabled><option value="">-- Consulta primero --</option></select>
            </div>
            <div class="control-grupo">
                 <button id="btn-pdf-individual" class="btn-secundario" disabled>Descargar PDF</button>
            </div>
             <div class="control-grupo">
                 <button id="btn-pdf-masivo" class="btn-secundario" disabled>Descarga Masiva</button>
            </div>
            <div id="loader"></div>
        </div>

        <div id="informe-container">
            <header>
                <h1>INFORME DE ORIENTACIÓN VOCACIONAL</h1>
                <p>Selecciona un colegio y haz clic en "Consultar" para empezar.</p>
            </header>
        </div>
    </div>

    <!-- INICIO DEL SCRIPT ACTUALIZADO -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyCvaIT9EGIgJu1VdPyugGY30-B9pNWFeyxk6F1GVZUfmkqyDCKHQnrgluOInjuB8GW/exec';
        const ETIQUETAS_AREAS = ["Ciencias Exactas y Agrarias", "Humanidades y Ciencias Sociales", "Artes", "Ciencias Sociales y Educación", "Ingeniería y Tecnología", "Administración y Negocios"];
        const ETIQUETAS_CORTAS = ["C_Ciencias", "H_Humanidades", "A_Artes", "S_Educacion", "I_Ingenieria", "D_Administracion"];

        const selectorColegio = document.getElementById('selector-colegio');
        const btnConsultar = document.getElementById('btn-consultar');
        const selectorEstudiante = document.getElementById('selector-estudiante');
        const informeContainer = document.getElementById('informe-container');
        const btnPdfIndividual = document.getElementById('btn-pdf-individual');
        const btnPdfMasivo = document.getElementById('btn-pdf-masivo');
        const loader = document.getElementById('loader');

        let chartInstance = null;
        let todosLosDatos = null; // CACHÉ GLOBAL PARA ALMACENAR TODOS LOS DATOS
        let colegiosCache = [];
        let estudiantesFiltrados = [];

        function mostrarLoader(mensaje) { loader.textContent = mensaje; }
        function ocultarLoader() { loader.textContent = ''; }

        function generarInformeHTML(estudiante) {
            const puntuacionMaxima = Math.max(...estudiante.puntuaciones);
            const indiceMaximo = estudiante.puntuaciones.indexOf(puntuacionMaxima);
            const areaDominanteCorta = ETIQUETAS_CORTAS[indiceMaximo];
            const areaDominante = ETIQUETAS_AREAS[indiceMaximo];
            
            let tablaHTML = '<table><tr><th>Área Vocacional</th><th>Puntuación</th></tr>';
            ETIQUETAS_AREAS.forEach((area, index) => {
                tablaHTML += `<tr><td>${area}</td><td>${estudiante.puntuaciones[index]}</td></tr>`;
            });
            tablaHTML += '</table>';
            
            const descripciones = {
                "C_Ciencias": "Te interesan las ciencias naturales, la investigación científica y el cuidado de la salud.",
                "H_Humanidades": "Te apasiona comprender el comportamiento humano, la sociedad y las cuestiones legales.",
                "A_Artes": "Tienes un perfil creativo y artístico. Te gusta expresarte a través de diferentes medios.",
                "S_Educacion": "Te apasiona enseñar, formar y contribuir al desarrollo de otros.",
                "I_Ingenieria": "Te fascina el diseño, la construcción y la tecnología.",
                "D_Administracion": "Tienes habilidades para la gestión, organización y los negocios."
            };
            
            return `
                <header>
                    <h1>INFORME DE ORIENTACIÓN VOCACIONAL</h1>
                    <p>Grupo Edúcate Colombia</p>
                </header>
                <div class="info-estudiante">
                    <p><strong>Nombre:</strong> ${estudiante.nombre}</p>
                    <p><strong>Correo:</strong> ${estudiante.correo}</p>
                    <p><strong>DANE:</strong> ${estudiante.dane}</p>
                    <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
                </div>
                <div class="resultados">
                    <div class="tabla-puntuaciones">${tablaHTML}</div>
                    <div class="grafico-container"><canvas id="radarChart"></canvas></div>
                </div>
                <div class="area-dominante">
                    <h2>TU ÁREA VOCACIONAL DOMINANTE</h2>
                    <p>Tu área de mayor interés es: <span class="area-dominante-nombre">${areaDominante}</span></p>
                    <p>Con una puntuación de: <strong>${puntuacionMaxima} de 50</strong></p>
                    <p><strong>Descripción:</strong> ${descripciones[areaDominanteCorta]}</p>
                </div>
            `;
        }

        function dibujarGrafico(puntuaciones) {
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('radarChart');
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ETIQUETAS_AREAS.map(l => l.split(' ')[0]),
                    datasets: [{
                        data: puntuaciones,
                        fill: true,
                        backgroundColor: 'rgba(44, 106, 194, 0.2)',
                        borderColor: 'rgb(44, 106, 194)',
                        pointBackgroundColor: 'rgb(44, 106, 194)',
                    }]
                },
                options: {
                    scales: { r: { suggestedMin: 0, suggestedMax: 50 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // CARGA INICIAL: Trae TODO de una vez para cachear los datos
        async function cargarTodosDatos() {
            mostrarLoader('Cargando datos del sistema...');
            try {
                const response = await fetch(`${API_URL}?endpoint=todo`);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                
                // Guardamos todos los datos en la caché global
                todosLosDatos = result.data;
                colegiosCache = todosLosDatos.colegios;
                
                // Llenar el selector de colegios desde la caché
                selectorColegio.innerHTML = '<option value="">-- Selecciona un Colegio --</option>';
                colegiosCache.forEach(colegio => {
                    const option = new Option(colegio.nombre, colegio.dane);
                    selectorColegio.appendChild(option);
                });
                
                mostrarLoader('✓ Datos cargados exitosamente');
                setTimeout(ocultarLoader, 1500);
            } catch (error) {
                alert('Error al cargar datos: ' + error.message);
                ocultarLoader();
            }
        }

        // Función para filtrar estudiantes localmente (SIN llamada a API)
        function filtrarEstudiantesPorColegio(dane) {
            return todosLosDatos.estudiantes.filter(est => est.dane == dane);
        }

        // Función para buscar un informe localmente (SIN llamada a API)
        function buscarInformeEstudiante(correo) {
            return todosLosDatos.estudiantes.find(est => est.correo == correo);
        }

        // --- MANEJO DE EVENTOS ---
        document.addEventListener('DOMContentLoaded', cargarTodosDatos);

        selectorColegio.addEventListener('change', () => {
            const dane = selectorColegio.value;
            btnConsultar.disabled = !dane;
            // Limpiamos y deshabilitamos el resto de la UI hasta que se consulte
            selectorEstudiante.innerHTML = '<option value="">-- Consulta primero --</option>';
            selectorEstudiante.disabled = true;
            btnPdfIndividual.disabled = true;
            btnPdfMasivo.disabled = true;
        });

        btnConsultar.addEventListener('click', () => {
            const dane = selectorColegio.value;
            if (!dane || !todosLosDatos) return;
            
            mostrarLoader('Filtrando estudiantes...');
            
            // Filtrado INSTANTÁNEO usando la caché (sin API)
            estudiantesFiltrados = filtrarEstudiantesPorColegio(dane);
            
            selectorEstudiante.innerHTML = '<option value="">-- Selecciona un Estudiante --</option>';
            if (estudiantesFiltrados.length === 0) {
                selectorEstudiante.innerHTML = '<option value="">No hay estudiantes</option>';
            } else {
                estudiantesFiltrados.forEach(estudiante => {
                    const option = new Option(estudiante.nombre, estudiante.correo);
                    selectorEstudiante.appendChild(option);
                });
            }
            
            selectorEstudiante.disabled = false;
            btnPdfMasivo.disabled = estudiantesFiltrados.length === 0;
            ocultarLoader();
        });

        selectorEstudiante.addEventListener('change', () => {
            const correo = selectorEstudiante.value;
            if (!correo || !todosLosDatos) return;
            
            mostrarLoader('Renderizando informe...');
            
            // Búsqueda INSTANTÁNEA usando la caché (sin API)
            const estudiante = buscarInformeEstudiante(correo);
            if (estudiante) {
                informeContainer.innerHTML = generarInformeHTML(estudiante);
                dibujarGrafico(estudiante.puntuaciones);
                btnPdfIndividual.disabled = false;
            }
            
            ocultarLoader();
        });

        // --- FUNCIONES PARA PDFs (ahora usan datos locales) ---
        window.jsPDF = window.jspdf.jsPDF;

        btnPdfIndividual.addEventListener('click', () => {
            const nombreEstudiante = selectorEstudiante.options[selectorEstudiante.selectedIndex].text;
            mostrarLoader('Generando PDF...');
            
            html2canvas(informeContainer).then(canvas => {
                const doc = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'letter' });
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                doc.save(`Informe - ${nombreEstudiante}.pdf`);
                ocultarLoader();
            });
        });

        btnPdfMasivo.addEventListener('click', async () => {
            if (estudiantesFiltrados.length === 0) return;
            if (!confirm(`Se generará un PDF con ${estudiantesFiltrados.length} informes. ¿Continuar?`)) return;
            
            const doc = new jsPDF({ orientation: 'landscape', unit: 'px', format: 'letter' });
            
            // Itera sobre el array local, SIN llamadas a la API
            for (let i = 0; i < estudiantesFiltrados.length; i++) {
                const estudiante = estudiantesFiltrados[i];
                mostrarLoader(`Generando PDF masivo (${i + 1} de ${estudiantesFiltrados.length}): ${estudiante.nombre}`);
                
                // Renderiza el informe y el gráfico
                informeContainer.innerHTML = generarInformeHTML(estudiante);
                dibujarGrafico(estudiante.puntuaciones);
                
                // Pequeña pausa para asegurar que el DOM se actualice antes de la captura
                await new Promise(r => setTimeout(r, 300));
                
                const canvas = await html2canvas(informeContainer);
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                if (i > 0) doc.addPage();
                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            }
            
            const nombreColegio = selectorColegio.options[selectorColegio.selectedIndex].text;
            doc.save(`Informe Compilado - ${nombreColegio}.pdf`);
            ocultarLoader();
            alert('¡Generación masiva completada!');
        });
    </script>
    <!-- FIN DEL SCRIPT ACTUALIZADO -->
</body>
</html>

