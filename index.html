<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Informes Vocacionales</title>
    <!-- Librerías Externas -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Plugin para mostrar etiquetas de datos directamente en Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    
    <style>
        :root { 
            --color-azul: #1E3A5F; 
            --color-fondo: #F0F2F5; 
            --color-primario-verde: #46B4A8; 
            --color-gris-claro: #E0E0E0;
            /* Colores pastel para gráficos y secciones */
            --color-pastel-rojo: #FFCCCC; /* Muy Bajo */
            --color-pastel-naranja: #FFFBEB; /* Bajo */
            --color-pastel-amarillo: #FFF3CD; /* Moderado */
            --color-pastel-verde-claro: #E2F0CB; /* Alto */
            --color-pastel-verde-oscuro: #D4EDDA; /* Muy Alto */
            --color-purpura-claro: #F3E5F5; /* Para Top 5 Carreras / Tendencias */
            --color-rojo-claro: #FFEBEE; /* Para recomendaciones institucionales */
            --color-texto-principal: #333;
        }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: #1E3A5F; color: #333; }
        .app-container { max-width: 1200px; margin: 30px auto; background: white; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .controles { display: flex; flex-wrap: wrap; gap: 10px; padding: 20px; background-color: var(--color-fondo); border-radius: 8px; margin-bottom: 30px; align-items: flex-end; }
        .control-grupo { display: flex; flex-direction: column; }
        .control-grupo label { font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #555; }
        select, button { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 13px; background-color: white; }
        button { cursor: pointer; background-color: var(--color-azul); color: white; border: none; font-weight: 600; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #12233a; }
        #loader { font-size: 14px; color: #555; margin-left: 10px; font-weight: 500; }
        
        /* Estilos para el informe individual en pantalla (sin cambios mayores aquí) */
        #informe-visual { width: 100%; height: 794px; display: flex; flex-direction: column; box-sizing: border-box; border: 1px solid #ccc; }
        #informe-visual header { background-color: var(--color-primario-verde); color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
        #informe-visual .logo { width: 250px; height: auto; }
        #informe-visual .titulo-informe h1 { margin: 0; font-size: 24px; font-weight: 700; }
        #informe-visual .titulo-informe p { margin: 5px 0 0; font-size: 14px; }
        #informe-visual .info-estudiante { display: flex; justify-content: space-between; padding: 15px 40px; }
        #informe-visual .info-estudiante p { margin: 4px 0; font-size: 13px; }
        #informe-visual .info-estudiante strong { font-weight: 600; }
        #informe-visual main { display: flex; flex: 1; padding: 0 40px; gap: 40px; overflow: hidden; }
        #informe-visual .columna-izquierda, #informe-visual .columna-derecha { display: flex; flex-direction: column; flex-basis: 50%; }
        #informe-visual .seccion-titulo { background-color: var(--color-azul); color: white; padding: 8px 12px; font-weight: 600; font-size: 14px; border-radius: 4px 4px 0 0; }
        #informe-visual .seccion-contenido { padding: 12px; border: 1px solid #E0E0E0; border-top: none; border-radius: 0 0 4px 4px; }
        #informe-visual table { width: 100%; border-collapse: collapse; font-size: 13px; }
        #informe-visual th, #informe-visual td { text-align: left; padding: 9px 12px; }
        #informe-visual th { background-color: var(--color-azul); color: white; font-weight: 600; }
        #informe-visual td:last-child { text-align: left; font-weight: 500; }
        #informe-visual tbody tr { background-color: #F0F2F5; }
        #informe-visual .area-dominante, #informe-visual .descripcion { margin-top: 15px; }
        #informe-visual .area-dominante p { font-size: 13px; line-height: 1.5; margin: 0; }
        #informe-visual .descripcion p { font-size: 13px; line-height: 1.5; margin: 0; text-align: left; }
        #informe-visual .area-dominante strong { font-weight: 700; }
        #informe-visual .grafico-container { height: 330px; display: flex; align-items: center; justify-content: center; border: 1px solid #E0E0E0; border-radius: 4px; padding: 10px; margin-bottom: 15px; }
        #informe-visual .carreras-sugeridas ul { list-style-type: none; padding-left: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 8px 20px; font-size: 13px; }
        #informe-visual .carreras-sugeridas ul li { padding-left: 1em; }
        #informe-visual .carreras-sugeridas ul li::before { content: '•'; color: var(--color-azul); font-weight: bold; display: inline-block; width: 1em; margin-left: -1em; }
        #informe-visual footer { background-color: var(--color-azul); color: white; padding: 15px 40px; text-align: center; font-size: 12px; line-height: 1.5; }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #FFFFFF; margin: 30px 0 20px 0; font-size: 28px;">Sistema de Orientación Vocacional - TEST CHASIDE</h1>
    <div class="app-container">
        <div class="controles">
            <div class="control-grupo"><label for="selector-colegio">1. Seleccionar Colegio:</label><select id="selector-colegio"><option value="">Cargando colegios...</option></select></div>
            <div class="control-grupo"><button id="btn-consultar" disabled>2. Consultar Estudiantes</button></div>
            <div class="control-grupo"><label for="selector-estudiante">3. Seleccionar Estudiante:</label><select id="selector-estudiante" disabled><option value="">-- Consulta primero --</option></select></div>
            <!-- Botones Actualizados y Nuevos -->
            <div class="control-grupo"><button id="btn-pdf-unico" disabled>Informe PDF Único</button></div>
            <div class="control-grupo"><button id="btn-pdf-compilado" disabled>Informe PDF Compilado</button></div>
            <div class="control-grupo"><button id="btn-pdf-individual-multiple" disabled>Informe PDF Individual</button></div>
            <div class="control-grupo"><button id="btn-pdf-grupal" disabled>Informe Grupal</button></div>
            <div id="loader"></div>
        </div>
        <div id="informe-container"></div>
    </div>

    <script>
        // Registrar el plugin de datalabels globalmente
        Chart.register(ChartDataLabels);

        // --- CONSTANTES Y SELECTORES GLOBALES ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwPQEnRJgO4CFjiQwZXHtqwLX6QXkmOnDG1hMr_U2Sj7ocv1f7R7iULt26Tdyh5gyN_/exec'; // URL de tu despliegue de Apps Script (AJUSTAR si cambia)
        const ETIQUETAS_AREAS = ["Ciencias Exactas y Agrarias", "Humanidades y Ciencias Sociales", "Artes", "Ciencias Sociales y Educación", "Ingeniería y Tecnología", "Administración y Negocios"];
        const ETIQUETAS_CORTAS = ["C_Ciencias", "H_Humanidades", "A_Artes", "S_Educacion", "I_Ingenieria", "D_Administracion"]; 
        const ETIQUETAS_CORTAS_GRAFICO = ["Ciencias", "Humanidades", "Artes", "Educación", "Ingeniería", "Administración"];
        const LOGO_BASE64 = 'COLOCA_AQUI_LA_CADENA_BASE64_DE_TU_LOGO_O_UN_LINK_A_LA_IMAGEN'; // Placeholder del logo

        const CARRERAS_SUGERIDAS_MAP = { // Objeto para mapear los nombres cortos de las áreas a sus carreras
            "C_Ciencias": ["Medicina", "Odontología", "Enfermería", "Fisioterapia", "Psicología", "Biología", "Química", "Farmacia"],
            "H_Humanidades": ["Derecho", "Ciencia Política", "Antropología", "Filosofía", "Trabajo Social", "Sociología", "Historia"],
            "A_Artes": ["Artes Plásticas", "Diseño Gráfico", "Comunicación Social", "Música", "Arquitectura", "Diseño Industrial", "Artes Escénicas", "Cinematografía"],
            "S_Educacion": ["Educación", "Pedagogía", "Psicología Educativa", "Educación Física", "Trabajo Social", "Licenciaturas diversas"],
            "I_Ingenieria": ["Ingeniería Civil", "Ingeniería Biomédica", "Ingeniería de Sistemas", "Ingeniería Industrial", "Tecnologías de la Información", "Ingeniería Electrónica", "Ingeniería Mecánica"],
            "D_Administracion": ["Contaduría", "Mercadeo", "Finanzas", "Administración de Empresas", "Economía", "Comercio Internacional", "Gestión de Recursos Humanos"]
        };


        const selectorColegio = document.getElementById('selector-colegio');
        const btnConsultar = document.getElementById('btn-consultar');
        const selectorEstudiante = document.getElementById('selector-estudiante');
        const informeContainer = document.getElementById('informe-container');
        const btnPdfUnico = document.getElementById('btn-pdf-unico');
        const btnPdfCompilado = document.getElementById('btn-pdf-compilado');
        const btnPdfIndividualMultiple = document.getElementById('btn-pdf-individual-multiple');
        const btnPdfGrupal = document.getElementById('btn-pdf-grupal');
        const loader = document.getElementById('loader');

        let chartInstance = null;
        let todosLosDatos = null;
        let estudiantesFiltrados = [];

        // --- FUNCIONES AUXILIARES ---
        function mostrarLoader(mensaje) { loader.textContent = mensaje; }
        function ocultarLoader() { loader.textContent = ''; }
        
        // --- LÓGICA DE CARGA DE DATOS ---
        async function cargarDatosIniciales() {
            mostrarLoader('Cargando datos del sistema...');
            try {
                const response = await fetch(`${API_URL}?endpoint=todo`);
                if (!response.ok) { throw new Error(`Error de red: ${response.statusText}`); }
                const json = await response.json();
                if (json.error) { throw new Error(json.error); }
                todosLosDatos = json.data;
                if (!todosLosDatos || !todosLosDatos.colegios) { throw new Error("La respuesta de la API no contiene los datos esperados."); }

                selectorColegio.innerHTML = '<option value="">-- Selecciona un Colegio --</option>';
                todosLosDatos.colegios.forEach(colegio => selectorColegio.add(new Option(colegio.nombre, colegio.dane)));

                mostrarLoader('✓ Datos cargados exitosamente');
                setTimeout(ocultarLoader, 1500);
            } catch (error) {
                alert('Error al cargar datos: ' + error.message);
                ocultarLoader();
            }
        }
        
        // --- FUNCIÓN DE RENDERIZADO EN PANTALLA (Informe Individual) ---
        function renderizarInformeEnPantalla(estudiante, colegioNombre) {
            if (chartInstance) chartInstance.destroy();
            const areaDominante = ETIQUETAS_AREAS[estudiante.puntuaciones.indexOf(estudiante.puntuacionMaxima)];
            const filasTablaHTML = ETIQUETAS_AREAS.map((area, i) => `<tr><td>${area}</td><td>${estudiante.puntuaciones[i]}</td></tr>`).join('');
            const carrerasHTML = estudiante.carreras.map(carrera => `<li>${carrera}</li>`).join('');

            informeContainer.innerHTML = `
                <div id="informe-visual">
                    <header>
                        <img src="${LOGO_BASE64.startsWith('data:') ? LOGO_BASE64 : ''}" alt="Logo Grupo Edúcate" class="logo">
                        <div class="titulo-informe"><h1>INFORME DE ORIENTACIÓN VOCACIONAL - TEST CHASIDE</h1><p>Colegio: ${colegioNombre}</p></div>
                    </header>
                    <section class="info-estudiante">
                        <div><p><strong>Nombre del estudiante:</strong> ${estudiante.nombre}</p><p><strong>Correo electrónico:</strong> ${estudiante.correo}</p></div>
                        <div><p><strong>DANE Colegio:</strong> ${estudiante.dane}</p><p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p></div>
                    </section>
                    <main>
                        <div class="columna-izquierda">
                            <table><thead><tr><th>Área vocacional</th><th>Puntuación</th></tr></thead><tbody>${filasTablaHTML}</tbody></table>
                            <div class="area-dominante">
                                <div class="seccion-titulo">Tu área vocacional dominante:</div>
                                <div class="seccion-contenido">
                                    <p>Área de mayor interés: <strong>${areaDominante}</strong></p>
                                    <p>Puntuación obtenida: <strong>${estudiante.puntuacionMaxima}</strong> de 50</p>
                                </div>
                            </div>
                            <div class="descripcion"><div class="seccion-titulo">Descripción:</div><div class="seccion-contenido"><p>${estudiante.descripcion}</p></div></div>
                        </div>
                        <div class="columna-derecha">
                            <div class="grafico-container"><canvas id="radarChart"></canvas></div>
                            <div class="carreras-sugeridas"><div class="seccion-titulo">Carreras sugeridas:</div><div class="seccion-contenido"><ul>${carrerasHTML}</ul></div></div>
                        </div>
                    </main>
                    <footer>En Grupo Edúcate Colombia creemos que la vocación es el punto de encuentro entre lo que amas y lo que haces bien. Acompañamos a cada estudiante en el descubrimiento de sus fortalezas e intereses, guiándolo hacia un futuro donde pueda crecer con pasión y propósito.</footer>
                </div>
            `;
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels: ETIQUETAS_CORTAS_GRAFICO, datasets: [{ data: estudiante.puntuaciones, fill: true, backgroundColor: 'rgba(30, 58, 95, 0.3)', borderColor: 'rgb(30, 58, 95)', pointBackgroundColor: 'rgb(30, 58, 95)' }] },
                options: { maintainAspectRatio: false, animation: false, scales: { r: { suggestedMin: 0, suggestedMax: 50, grid: { color: '#ddd' }, pointLabels: { font: { size: 12, family: 'Montserrat' } } } }, plugins: { legend: { display: false } } }
            });
        }
        
        // --- MOTOR DE GENERACIÓN DE PDF INDIVIDUAL ---
        window.jsPDF = window.jspdf.jsPDF;

        function generarPaginaPdf(doc, estudiante, colegioNombre) {
            const areaDominante = ETIQUETAS_AREAS[estudiante.puntuaciones.indexOf(estudiante.puntuacionMaxima)];
            doc.setFillColor('#46B4A8'); doc.rect(0, 0, doc.internal.pageSize.getWidth(), 80, 'F');
            if (LOGO_BASE64 && LOGO_BASE64.startsWith('data:')) { // Solo si es Base64
                const logoWidth = 150; 
                const logoHeight = logoWidth * 0.40;
                doc.addImage(LOGO_BASE64, 'PNG', 40, 5, logoWidth, logoHeight); 
            } else { // Si es un link o placeholder, mostrar texto
                doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
                doc.text('GRUPO EDUCATE COLOMBIA', 40, 30);
            }

            doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(17);
            doc.text('INFORME DE ORIENTACIÓN VOCACIONAL - TEST CHASIDE', doc.internal.pageSize.getWidth() - 40, 40, { align: 'right' });
            doc.setFont('helvetica', 'normal'); doc.setFontSize(12);
            doc.text(`Colegio: ${colegioNombre}`, doc.internal.pageSize.getWidth() - 40, 60, { align: 'right' });
            
            doc.setTextColor('#333'); doc.setFontSize(11); doc.setFont('helvetica', 'bold');
            doc.text('Nombre del estudiante:', 40, 110); doc.text('Correo electrónico:', 40, 125);
            doc.text('DANE Colegio:', 550, 110); doc.text('Fecha:', 550, 125);
            doc.setFont('helvetica', 'normal');
            doc.text(estudiante.nombre, 180, 110); doc.text(estudiante.correo, 180, 125);
            doc.text(String(estudiante.dane), 650, 110); doc.text(new Date().toLocaleDateString('es-ES'), 650, 125);
            
            const tablaBody = ETIQUETAS_AREAS.map((area, i) => [area, estudiante.puntuaciones[i]]);
            doc.autoTable({
                startY: 150, head: [['Área vocacional', 'Puntuación']], body: tablaBody,
                headStyles: { fillColor: '#1E3A5F', font: 'helvetica', fontStyle: 'bold' },
                bodyStyles: { font: 'helvetica', fontSize: 10 },
                columnStyles: { 0: { cellWidth: 280 }, 1: { cellWidth: 70, halign: 'left' } },
                margin: { left: 40 }
            });
            let finalY = doc.autoTable.previous.finalY + 20;

            doc.setFillColor('#1E3A5F'); doc.roundedRect(40, finalY, 350, 22, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text('Tu área vocacional dominante:', 50, finalY + 15);
            doc.setDrawColor('#E0E0E0'); doc.roundedRect(40, finalY + 22, 350, 45, 3, 3, 'D'); 
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(`Área de mayor interés: `, 50, finalY + 38);
            doc.setFont('helvetica', 'bold'); doc.text(areaDominante, 155, finalY + 38);
            doc.setFont('helvetica', 'normal');
            doc.text(`Puntuación obtenida: `, 50, finalY + 53);
            doc.setFont('helvetica', 'bold'); doc.text(`${estudiante.puntuacionMaxima} de 50`, 155, finalY + 53);
            finalY += (22 + 45 + 10);

            doc.setFillColor('#1E3A5F'); doc.roundedRect(40, finalY, 350, 22, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text('Descripción:', 50, finalY + 15);
            const descLines = doc.splitTextToSize(estudiante.descripcion, 330);
            const descHeight = descLines.length * 12 + 15;
            doc.setDrawColor('#E0E0E0'); doc.roundedRect(40, finalY + 22, 350, descHeight, 3, 3, 'D');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(descLines, 50, finalY + 37, { align: 'justify', maxWidth: 330 });

            // Para el gráfico de radar individual, necesitamos un canvas temporal si no hay uno visible
            let chartCanvas = document.getElementById('radarChart');
            let tempCanvasCreated = false;
            if (!chartCanvas) {
                chartCanvas = document.createElement('canvas');
                chartCanvas.width = 700; // Un tamaño razonable para la captura
                chartCanvas.height = 400;
                tempCanvasCreated = true;
            }
            const ctx = chartCanvas.getContext('2d');
            
            // Destruir instancia previa si existe y es temporal
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels: ETIQUETAS_CORTAS_GRAFICO, datasets: [{ data: estudiante.puntuaciones, fill: true, backgroundColor: 'rgba(30, 58, 95, 0.3)', borderColor: 'rgb(30, 58, 95)', pointBackgroundColor: 'rgb(30, 58, 95)' }] },
                options: { 
                    maintainAspectRatio: false, 
                    animation: false, 
                    scales: { 
                        r: { 
                            suggestedMin: 0, suggestedMax: 50, grid: { color: '#ddd' }, pointLabels: { font: { size: 12, family: 'Montserrat' } } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: false }, // Deshabilitar tooltips para impresión
                        datalabels: {
                            display: true,
                            color: 'black',
                            font: { weight: 'bold', size: 8 },
                            formatter: (value) => value.toFixed(0) // Mostrar puntuación sin decimales
                        }
                    }
                }
            });

            // Esperar a que el gráfico se renderice antes de capturar la imagen
            await new Promise(r => setTimeout(r, 150)); // Pequeño retraso para asegurar el render
            
            ctx.save();
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = 'white'; 
            ctx.fillRect(0, 0, chartCanvas.width, chartCanvas.height);
            ctx.restore();
            
            const chartImage = chartCanvas.toDataURL('image/jpeg', 0.8);
            doc.setDrawColor('#E0E0E0');
            doc.roundedRect(430, 150, 350, 250, 3, 3, 'D');
            doc.addImage(chartImage, 'JPEG', 435, 155, 340, 240);
            
            // Destruir el canvas temporal si fue creado para liberar memoria
            if (tempCanvasCreated) {
                chartInstance.destroy(); // Destruir la instancia de Chart.js
                chartInstance = null; // Resetear la referencia
            }


            let startYCarreras = 430;
            doc.setFillColor('#1E3A5F'); doc.roundedRect(430, startYCarreras, 350, 22, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text('Carreras sugeridas:', 440, startYCarreras + 15);
            const carrerasHeight = Math.ceil(estudiante.carreras.length / 2) * 15 + 15;
            doc.setDrawColor('#E0E0E0'); doc.roundedRect(430, startYCarreras + 22, 350, carrerasHeight, 3, 3, 'D');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            estudiante.carreras.forEach((carrera, index) => {
                const x = (index % 2 === 0) ? 450 : 610;
                const y = startYCarreras + 40 + Math.floor(index / 2) * 15;
                doc.text(`• ${carrera}`, x, y);
            });

            doc.setFillColor('#1E3A5F');
            doc.rect(0, doc.internal.pageSize.getHeight() - 60, doc.internal.pageSize.getWidth(), 60, 'F');
            doc.setTextColor('white'); doc.setFontSize(9);
            const footerText = "En Grupo Edúcate Colombia creemos que la vocación es el punto de encuentro entre lo que amas y lo que haces bien. Acompañamos a cada estudiante en el descubrimiento de sus fortalezas e intereses, guiándolo hacia un futuro donde pueda crecer con pasión y propósito.";
            doc.text(footerText, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 35, { align: 'center', maxWidth: 700 });
        }

        // --- ¡NUEVO/EXPANDIDO! LÓGICA Y GENERACIÓN DE PDF GRUPAL ---
        function analizarDatosGrupales() {
            const totalEstudiantes = estudiantesFiltrados.length;
            if (totalEstudiantes === 0) return null;

            const datosGrupalesCalculados = {
                totalEstudiantes: totalEstudiantes,
                fechaAplicacion: new Date().toLocaleDateString('es-ES'),
                anioActual: new Date().getFullYear(),
                estudiantesConAreaDominante: estudiantesFiltrados.filter(e => e.areaDominanteCorta).length,
                tasaFinalizacion: (estudiantesFiltrados.filter(e => e.areaDominanteCorta).length / totalEstudiantes) * 100,
                
                puntuacionesTodas: estudiantesFiltrados.flatMap(e => e.puntuaciones),
                distribucionAreas: {}, 
                promediosAreas: new Array(ETIQUETAS_AREAS.length).fill(0),
                minMaxAreas: new Array(ETIQUETAS_AREAS.length).fill({ min: 50, max: 0 }), // Max puntuacion es 50
                nivelesInteres: {}
            };

            ETIQUETAS_CORTAS.forEach((areaKey, i) => {
                datosGrupalesCalculados.distribucionAreas[areaKey] = {
                    nombre: ETIQUETAS_AREAS[i],
                    cantidad: 0,
                    porcentaje: 0,
                    puntuacionPromedio: 0,
                    rango: ""
                };
                datosGrupalesCalculados.nivelesInteres[ETIQUETAS_CORTAS_GRAFICO[i]] = {
                    'Muy Alto': 0, 'Alto': 0, 'Moderado': 0, 'Bajo': 0, 'Muy Bajo': 0
                };
            });

            for (const est of estudiantesFiltrados) {
                if (est.areaDominanteCorta && datosGrupalesCalculados.distribucionAreas[est.areaDominanteCorta]) {
                    datosGrupalesCalculados.distribucionAreas[est.areaDominanteCorta].cantidad++;
                }
                est.puntuaciones.forEach((p, i) => {
                    datosGrupalesCalculados.promediosAreas[i] += p;
                    datosGrupalesCalculados.minMaxAreas[i] = {
                        min: Math.min(datosGrupalesCalculados.minMaxAreas[i].min, p),
                        max: Math.max(datosGrupalesCalculados.minMaxAreas[i].max, p)
                    };

                    const areaGraphName = ETIQUETAS_CORTAS_GRAFICO[i];
                    if (p >= 40) datosGrupalesCalculados.nivelesInteres[areaGraphName]['Muy Alto']++;
                    else if (p >= 30) datosGrupalesCalculados.nivelesInteres[areaGraphName]['Alto']++;
                    else if (p >= 20) datosGrupalesCalculados.nivelesInteres[areaGraphName]['Moderado']++;
                    else if (p >= 10) datosGrupalesCalculados.nivelesInteres[areaGraphName]['Bajo']++;
                    else datosGrupalesCalculados.nivelesInteres[areaGraphName]['Muy Bajo']++;
                });
            }

            datosGrupalesCalculados.promediosAreas = datosGrupalesCalculados.promediosAreas.map(total => parseFloat((total / totalEstudiantes).toFixed(2)));
            ETIQUETAS_CORTAS.forEach((areaKey, i) => {
                const dist = datosGrupalesCalculados.distribucionAreas[areaKey];
                dist.porcentaje = (dist.cantidad / totalEstudiantes) * 100;
                dist.puntuacionPromedio = datosGrupalesCalculados.promediosAreas[i];
                dist.rango = `${datosGrupalesCalculados.minMaxAreas[i].min} - ${datosGrupalesCalculados.minMaxAreas[i].max}`;
            });

            const distribucionAreasOrdenada = Object.values(datosGrupalesCalculados.distribucionAreas).sort((a, b) => b.cantidad - a.cantidad);
            datosGrupalesCalculados.distribucionAreasOrdenada = distribucionAreasOrdenada; 

            datosGrupalesCalculados.promedioGeneral = parseFloat((datosGrupalesCalculados.puntuacionesTodas.reduce((sum, val) => sum + val, 0) / datosGrupalesCalculados.puntuacionesTodas.length).toFixed(2));
            datosGrupalesCalculados.maximaPuntuacionRegistrada = Math.max(...datosGrupalesCalculados.puntuacionesTodas);
            datosGrupalesCalculados.minimaPuntuacionRegistrada = Math.min(...datosGrupalesCalculados.puntuacionesTodas);
            datosGrupalesCalculados.desviacionEstandar = parseFloat(Math.sqrt(datosGrupalesCalculados.puntuacionesTodas.map(x => Math.pow(x - datosGrupalesCalculados.promedioGeneral, 2)).reduce((a, b) => a + b) / datosGrupalesCalculados.puntuacionesTodas.length).toFixed(2));

            datosGrupalesCalculados.areaMasPopular = distribucionAreasOrdenada[0];
            datosGrupalesCalculados.areaMenosPopular = distribucionAreasOrdenada[distribucionAreasOrdenada.length - 1];
            
            const areaMayorInteres = ETIQUETAS_AREAS[datosGrupalesCalculados.promediosAreas.indexOf(Math.max(...datosGrupalesCalculados.promediosAreas))];
            const areaMenorInteres = ETIQUETAS_AREAS[datosGrupalesCalculados.promediosAreas.indexOf(Math.min(...datosGrupalesCalculados.promediosAreas))];
            datosGrupalesCalculados.areaConMayorInteresPromedio = { nombre: areaMayorInteres, puntuacion: Math.max(...datosGrupalesCalculados.promediosAreas) };
            datosGrupalesCalculados.areaConMenorInteresPromedio = { nombre: areaMenorInteres, puntuacion: Math.min(...datosGrupalesCalculados.promediosAreas) };

            const top5Carreras = (CARRERAS_SUGERIDAS_MAP[ETIQUETAS_CORTAS[ETIQUETAS_AREAS.indexOf(datosGrupalesCalculados.areaMasPopular.nombre)]] || []).slice(0, 5);
            datosGrupalesCalculados.top5Carreras = top5Carreras;

            return datosGrupalesCalculados;
        }

        async function generarPdfGrupal(colegioNombre) {
            mostrarLoader('Analizando y generando Informe Grupal...');
            
            // MODIFICACIÓN CLAVE: Capturar el resultado de analizarDatosGrupales()
            const datosCalculadosGrupales = analizarDatosGrupales(); 
            if (!datosCalculadosGrupales) {
                alert('No hay estudiantes filtrados para generar el informe grupal.');
                ocultarLoader();
                return;
            }

            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
            
            // Constantes de color para el PDF
            const COLOR_AZUL = '#1E3A5F';
            const COLOR_PRIMARIO_VERDE = '#46B4A8';
            const COLOR_GRIS_CLARO = '#E0E0E0';
            const COLOR_AMARILLO_CLARO = '#FFFBE6';
            const COLOR_NARANJA_CLARO = '#FFF3E0';
            const COLOR_PURPURA_CLARO = '#F3E5F5';
            const COLOR_ROJO_CLARO = '#FFEBEE';

            // Colores para los niveles de interés (ajustados a la imagen de referencia)
            const levelsColors = ['#FFCCCC', '#FFFBEB', '#FFF3CD', '#E2F0CB', '#D4EDDA']; 

            // Función para generar encabezado de página
            const generateHeader = (pageNumber, totalPages) => {
                doc.setFillColor(COLOR_PRIMARIO_VERDE); 
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 80, 'F');
                if (LOGO_BASE64 && LOGO_BASE64.startsWith('data:')) { // Si es Base64
                    const logoWidth = 150; 
                    const logoHeight = logoWidth * 0.40;
                    doc.addImage(LOGO_BASE64, 'PNG', 40, 5, logoWidth, logoHeight); 
                } else { // Si es un link o placeholder, mostrar texto
                    doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
                    doc.text('GRUPO EDUCATE COLOMBIA', 40, 30);
                }

                doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(18);
                doc.text('INFORME GRUPAL - ANÁLISIS DE ORIENTACIÓN VOCACIONAL', doc.internal.pageSize.getWidth() - 40, 40, { align: 'right' });
                doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
                doc.text(`Test CHASIDE - Colegio: ${colegioNombre}`, doc.internal.pageSize.getWidth() - 40, 55, { align: 'right' });
                doc.text(`Grado: 11° - Año: ${datosCalculadosGrupales.anioActual}`, doc.internal.pageSize.getWidth() - 40, 68, { align: 'right' });
            };

            // Función para generar pie de página
            const generateFooter = (pageNumber, totalPages) => {
                doc.setFillColor(COLOR_AZUL);
                doc.rect(0, doc.internal.pageSize.getHeight() - 40, doc.internal.pageSize.getWidth(), 40, 'F');
                doc.setTextColor('white'); doc.setFontSize(8);
                const footerText = `Este informe presenta un análisis agregado de las tendencias vocacionales del grupo y no reemplaza la orientación individual de cada estudiante.`;
                doc.text(footerText, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 25, { align: 'center', maxWidth: 700 });
                doc.text(`Página ${pageNumber} de ${totalPages}`, doc.internal.pageSize.getWidth() - 50, doc.internal.pageSize.getHeight() - 25, { align: 'right' });
            };

            // Helper para dibujar gráficos y añadir al PDF
            const drawChartAndAddToPdf = async (chartId, title, chartType, chartData, chartOptions, positionX, positionY, width, height) => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 700; // Resolución para la imagen
                tempCanvas.height = 400; 
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.fillStyle = 'white'; 
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

                let chart = new Chart(tempCtx, {
                    type: chartType,
                    data: chartData,
                    options: chartOptions,
                    plugins: [ChartDataLabels]
                });
                
                await new Promise(resolve => setTimeout(resolve, 100)); // Pequeña pausa para render
                
                const chartImage = tempCanvas.toDataURL('image/jpeg', 0.9);
                doc.setDrawColor(COLOR_GRIS_CLARO);
                doc.roundedRect(positionX, positionY, width, height, 3, 3, 'D');
                doc.addImage(chartImage, 'JPEG', positionX + 5, positionY + 5, width - 10, height - 10);

                doc.setTextColor(COLOR_AZUL); doc.setFont('helvetica', 'bold'); doc.setFontSize(10);
                // Ajuste para el título del gráfico apilado, es más grande y ya lleva 'GRÁFICO:'
                if (chartId === 'stackedBarChart') {
                    doc.setFontSize(12);
                    doc.text(title, positionX + 10, positionY + 18); // Ajuste de Y para el título más grande
                } else {
                    doc.setFontSize(10);
                    doc.text(title, positionX + 10, positionY + 15);
                }
                
                chart.destroy(); 
            };


            // --- Página 1: Resumen Ejecutivo y Hallazgos ---
            generateHeader(1, 4);
            doc.setTextColor('#333'); doc.setFontSize(12);

            // Resumen Ejecutivo
            let currentY = 100;
            doc.setFillColor(COLOR_PRIMARIO_VERDE); doc.roundedRect(40, currentY, doc.internal.pageSize.getWidth() - 80, 18, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('RESUMEN EJECUTIVO', 50, currentY + 12);
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
            currentY += 30;
            doc.text(`Total de estudiantes evaluados: ${datosCalculadosGrupales.totalEstudiantes}`, 50, currentY);
            doc.text(`Fecha de aplicación: ${datosCalculadosGrupales.fechaAplicacion}`, 250, currentY);
            currentY += 15;
            doc.text(`Estudiantes con área dominante identificada: ${datosCalculadosGrupales.estudiantesConAreaDominante}`, 50, currentY);
            doc.text(`Tasa de finalización: ${datosCalculadosGrupales.tasaFinalizacion.toFixed(1)}%`, 250, currentY);
            currentY += 25;
            doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor(COLOR_AZUL);
            doc.text('Estadísticas Básicas de Puntuación', 50, currentY);
            currentY += 5;
            doc.autoTable({
                startY: currentY,
                head: [['Estadística', 'Valor']],
                body: [
                    ['Puntuación promedio general', `${datosCalculadosGrupales.promedioGeneral.toFixed(2)} puntos`],
                    ['Puntuación máxima registrada', `${datosCalculadosGrupales.maximaPuntuacionRegistrada} puntos`],
                    ['Puntuación mínima registrada', `${datosCalculadosGrupales.minimaPuntuacionRegistrada} puntos`],
                    ['Desviación estándar', `${datosCalculadosGrupales.desviacionEstandar.toFixed(2)}`]
                ],
                headStyles: { fillColor: COLOR_AZUL, font: 'helvetica', fontStyle: 'bold', fontSize: 8 },
                bodyStyles: { font: 'helvetica', fontSize: 8 },
                columnStyles: { 0: { cellWidth: 120 }, 1: { cellWidth: 80, fontStyle: 'bold', textColor: COLOR_AZUL } },
                margin: { left: 45, right: 400 },
                theme: 'grid'
            });
            currentY = doc.autoTable.previous.finalY + 20;


            // Hallazgos Principales
            doc.setFillColor(COLOR_AMARILLO_CLARO); doc.roundedRect(40, currentY, doc.internal.pageSize.getWidth() - 80, 18, 3, 3, 'F');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('HALLAZGOS PRINCIPALES', 50, currentY + 12);
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
            currentY += 30;
            doc.text(`• Área dominante más frecuente: ${datosCalculadosGrupales.areaMasPopular.nombre} (${datosCalculadosGrupales.areaMasPopular.cantidad} estudiantes, ${datosCalculadosGrupales.areaMasPopular.porcentaje.toFixed(1)}%).`, 50, currentY);
            currentY += 15;
            doc.text(`• Área con mayor interés promedio: ${datosCalculadosGrupales.areaConMayorInteresPromedio.nombre} (${datosCalculadosGrupales.areaConMayorInteresPromedio.puntuacion.toFixed(2)} puntos).`, 50, currentY);
            currentY += 15;
            doc.text(`• Puntuación promedio general del grupo: ${datosCalculadosGrupales.promedioGeneral.toFixed(2)} puntos.`, 50, currentY);
            currentY += 15;
            doc.text(doc.splitTextToSize(`• El grupo muestra una tendencia hacia áreas de ${datosCalculadosGrupales.areaMasPopular.nombre}, mientras que ${datosCalculadosGrupales.areaMenosPopular.nombre} es la menos explorada.`, doc.internal.pageSize.getWidth() - 100), 50, currentY);
            currentY += 30;


            // TOP 5 de Carreras Más Recomendadas al Grupo
            doc.setFillColor(COLOR_PRIMARIO_VERDE); doc.roundedRect(40, currentY, doc.internal.pageSize.getWidth() - 80, 18, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('TOP 5 DE CARRERAS MÁS RECOMENDADAS AL GRUPO', 50, currentY + 12);
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
            currentY += 30;
            doc.text(`Según el área dominante más frecuente (${datosCalculadosGrupales.areaMasPopular.nombre}), las carreras más sugeridas son:`, 50, currentY);
            currentY += 10;
            datosCalculadosGrupales.top5Carreras.forEach((carrera, index) => {
                doc.text(`${index + 1}. ${carrera}`, 60, currentY + (index * 10));
            });
            currentY += (datosCalculadosGrupales.top5Carreras.length * 10) + 10;

            // Acciones Inmediatas Recomendadas (Solo títulos)
            doc.setFillColor(COLOR_ROJO_CLARO); doc.roundedRect(40, currentY, doc.internal.pageSize.getWidth() - 80, 18, 3, 3, 'F');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('ACCIONES INMEDIATAS RECOMENDADAS', 50, currentY + 12);
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
            currentY += 30;
            doc.text(`1. Orientación Focalizada: Organizar charlas con profesionales del área de ${datosCalculadosGrupales.areaMasPopular.nombre} y programar visitas a universidades con programas en estas áreas.`, 50, currentY, { maxWidth: doc.internal.pageSize.getWidth() - 100 });
            currentY += 20;
            doc.text(`2. Fortalecimiento de Áreas Minoritarias: Crear espacios de exploración para áreas menos populares (${datosCalculadosGrupales.areaMenosPopular.nombre}) para asegurar una visión completa.`, 50, currentY, { maxWidth: doc.internal.pageSize.getWidth() - 100 });
            currentY += 20;
            doc.text(`3. Seguimiento Personalizado: Identificar estudiantes con puntuaciones muy bajas o inconsistentes para sesiones de orientación individual.`, 50, currentY, { maxWidth: doc.internal.pageSize.getWidth() - 100 });
            currentY += 20;


            generateFooter(1, 4);

            // --- Página 2: Distribución de Áreas y Gráficos ---
            doc.addPage();
            generateHeader(2, 4);
            currentY = 100;

            // Distribución por Áreas Vocacionales (Tabla) - COLUMNA IZQUIERDA
            doc.setFillColor(COLOR_NARANJA_CLARO); doc.roundedRect(40, currentY, 400, 18, 3, 3, 'F');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'bold'); doc.setFontSize(10);
            doc.text('DISTRIBUCIÓN DE ESTUDIANTES POR ÁREA VOCACIONAL', 50, currentY + 12);
            currentY += 25;
            const tablaDistribucionBody = ETIQUETAS_CORTAS.map((areaKey, i) => {
                const dist = datosCalculadosGrupales.distribucionAreas[areaKey];
                return [dist.nombre, dist.cantidad, `${dist.porcentaje.toFixed(1)}%`, dist.puntuacionPromedio.toFixed(2), dist.rango];
            });
            tablaDistribucionBody.push(['TOTAL', datosCalculadosGrupales.totalEstudiantes, '100.0%', datosCalculadosGrupales.promedioGeneral.toFixed(2), '-']);

            doc.autoTable({
                startY: currentY,
                head: [['Área Vocacional', 'Cantidad', 'Porcentaje', 'Puntuación Promedio', 'Rango']],
                body: tablaDistribucionBody,
                headStyles: { fillColor: COLOR_AZUL, font: 'helvetica', fontStyle: 'bold', fontSize: 8 },
                bodyStyles: { font: 'helvetica', fontSize: 8 },
                columnStyles: { 
                    0: { cellWidth: 110 },
                    1: { cellWidth: 50, halign: 'center' },
                    2: { cellWidth: 50, halign: 'center' },
                    3: { cellWidth: 60, halign: 'center' },
                    4: { cellWidth: 70, halign: 'center' }
                },
                margin: { left: 45, right: 400 },
                theme: 'grid',
                didDrawCell: data => {
                    if (data.row.section === 'body' && data.row.index === (tablaDistribucionBody.length - 1)) { // Última fila 'TOTAL'
                        doc.setFillColor(COLOR_AZUL);
                        doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                        doc.setTextColor('white');
                    }
                }
            });
            currentY = doc.autoTable.previous.finalY + 20;

            // Análisis de Tendencias y Patrones Detallado - COLUMNA IZQUIERDA
            doc.setFillColor(COLOR_PURPURA_CLARO); doc.roundedRect(40, currentY, 400, 18, 3, 3, 'F');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'bold'); doc.setFontSize(10);
            doc.text('ANÁLISIS DE TENDENCIAS Y PATRONES', 50, currentY + 12);
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
            currentY += 25;
            doc.text(`Área vocacional más popular: ${datosCalculadosGrupales.areaMasPopular.nombre} (${datosCalculadosGrupales.areaMasPopular.cantidad} estudiantes, ${datosCalculadosGrupales.areaMasPopular.porcentaje.toFixed(1)}%).`, 50, currentY, { maxWidth: 390 });
            currentY += 15;
            doc.text(`Área vocacional menos popular: ${datosCalculadosGrupales.areaMenosPopular.nombre} (${datosCalculadosGrupales.areaMenosPopular.cantidad} estudiantes, ${datosCalculadosGrupales.areaMenosPopular.porcentaje.toFixed(1)}%).`, 50, currentY, { maxWidth: 390 });
            currentY += 15;
            doc.text(`Área con mayor interés promedio: ${datosCalculadosGrupales.areaConMayorInteresPromedio.nombre} con ${datosCalculadosGrupales.areaConMayorInteresPromedio.puntuacion.toFixed(2)} puntos.`, 50, currentY, { maxWidth: 390 });
            currentY += 15;
            doc.text(`Área con menor interés promedio: ${datosCalculadosGrupales.areaConMenorInteresPromedio.nombre} con ${datosCalculadosGrupales.areaConMenorInteresPromedio.puntuacion.toFixed(2)} puntos.`, 50, currentY, { maxWidth: 390 });
            currentY += 15;


            // --- Gráficos - COLUMNA DERECHA ---
            let chartX = 460;
            let chartY = 100;
            const chartWidth = 330;
            const chartHeight = 150; // Altura estándar para la mayoría de los gráficos
            const chartGap = 15; // Espacio entre gráficos


            // Gráfico de Barras: Distribución de Estudiantes por Área Vocacional
            await drawChartAndAddToPdf(
                'barChart', 
                'Gráfico: Distribución de Estudiantes por Área Vocacional', 
                'bar', 
                {
                    labels: datosCalculadosGrupales.distribucionAreasOrdenada.map(d => d.nombre),
                    datasets: [{
                        label: 'N° de Estudiantes',
                        data: datosCalculadosGrupales.distribucionAreasOrdenada.map(d => d.cantidad),
                        backgroundColor: COLOR_AZUL,
                        borderColor: COLOR_AZUL,
                        borderWidth: 1
                    }]
                },
                {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false, animation: false,
                    scales: { x: { beginAtZero: true, ticks: { precision: 0 } }, y: { ticks: { font: { size: 9, family: 'Montserrat' } }, grid: { display: false } } },
                    plugins: { 
                        legend: { display: false }, title: { display: false }, tooltip: { enabled: false },
                        datalabels: { display: true, color: 'black', anchor: 'end', align: 'end', offset: 4, font: { weight: 'bold', size: 8 } }
                    }
                },
                chartX, chartY, chartWidth, chartHeight
            );
            chartY += chartHeight + chartGap;

            // Gráfico Circular: Porcentaje de Estudiantes por Área
            const pieBackgroundColors = ['#1E3A5F', '#46B4A8', '#A2D9CE', '#7B8D9F', '#C2D4E3', '#4E6A8A'];
            await drawChartAndAddToPdf(
                'pieChart', 
                'Gráfico: Porcentaje de Estudiantes por Área', 
                'pie', 
                {
                    labels: ETIQUETAS_CORTAS_GRAFICO,
                    datasets: [{
                        data: ETIQUETAS_CORTAS.map((areaKey) => datosCalculadosGrupales.distribucionAreas[areaKey].cantidad),
                        backgroundColor: pieBackgroundColors, hoverOffset: 4
                    }]
                },
                {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: {
                        legend: { position: 'right', labels: { font: { family: 'Montserrat', size: 9 } } },
                        title: { display: false }, tooltip: { enabled: false },
                        datalabels: { display: true, color: 'white', formatter: (value, ctx) => {
                                let sum = 0; let dataArr = ctx.chart.data.datasets[0].data; dataArr.map(data => { sum += data; });
                                let percentage = (value * 100 / sum).toFixed(0) + '%'; return percentage;
                            },
                            font: { weight: 'bold', size: 10 }, anchor: 'center', align: 'center', offset: 0
                        }
                    }
                },
                chartX, chartY, chartWidth, chartHeight
            );
            chartY += chartHeight + chartGap;

            // Gráfico de Radar: Perfil Vocacional Promedio del Grupo
            await drawChartAndAddToPdf(
                'radarChart', 
                'Gráfico: Perfil Vocacional Promedio del Grupo', 
                'radar', 
                {
                    labels: ETIQUETAS_CORTAS_GRAFICO,
                    datasets: [{
                        data: datosCalculadosGrupales.promediosAreas, fill: true, backgroundColor: 'rgba(30, 58, 95, 0.3)', 
                        borderColor: COLOR_AZUL, pointBackgroundColor: COLOR_AZUL, pointBorderColor: '#fff', 
                        pointHoverBackgroundColor: '#fff', pointHoverBorderColor: COLOR_AZUL
                    }]
                },
                {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: { r: { beginAtZero: true, suggestedMin: 0, suggestedMax: 50, grid: { color: COLOR_GRIS_CLARO }, pointLabels: { font: { size: 9, family: 'Montserrat' } } } },
                    plugins: {
                        legend: { display: false }, title: { display: false }, tooltip: { enabled: false },
                        datalabels: { display: true, color: 'black', font: { weight: 'bold', size: 8 }, formatter: (value) => value.toFixed(0) }
                    }
                },
                chartX, chartY, chartWidth, chartHeight
            );


            generateFooter(2, 4);

            // --- Página 3: Niveles de Interés y Recomendaciones Institucionales ---
            doc.addPage();
            generateHeader(3, 4);
            currentY = 100;

            // Distribución por Niveles de Interés (Tabla)
            doc.setFillColor(COLOR_AMARILLO_CLARO); doc.roundedRect(40, currentY, doc.internal.pageSize.getWidth() - 80, 18, 3, 3, 'F');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('DISTRIBUCIÓN POR NIVELES DE INTERÉS', 50, currentY + 12);
            currentY += 25;

            const nivelesInteresHead = [['Área', 'Muy Alto (40-50)', 'Alto (30-39)', 'Moderado (20-29)', 'Bajo (10-19)', 'Muy Bajo (0-9)']];
            const nivelesInteresBody = ETIQUETAS_CORTAS_GRAFICO.map(areaName => {
                const levels = datosCalculadosGrupales.nivelesInteres[areaName];
                return [areaName, levels['Muy Alto'], levels['Alto'], levels['Moderado'], levels['Bajo'], levels['Muy Bajo']];
            });
            doc.autoTable({
                startY: currentY,
                head: nivelesInteresHead,
                body: nivelesInteresBody,
                headStyles: { fillColor: COLOR_AZUL, font: 'helvetica', fontStyle: 'bold', fontSize: 8, halign: 'center' },
                bodyStyles: { font: 'helvetica', fontSize: 8, halign: 'center' },
                columnStyles: { 0: { cellWidth: 80, halign: 'left' } },
                margin: { left: 45, right: 400 },
                theme: 'grid',
                didParseCell: (data) => { // Para aplicar colores de fondo condicionales
                    if (data.section === 'body' && data.column.index > 0) {
                        const value = data.cell.raw;
                        if (value >= 40) data.cell.styles.fillColor = '#D4EDDA'; // Muy Alto
                        else if (value >= 30) data.cell.styles.fillColor = '#E2F0CB'; // Alto
                        else if (value >= 20) data.cell.styles.fillColor = '#FFF3CD'; // Moderado
                        else if (value >= 10) data.cell.styles.fillColor = '#FFFBEB'; // Bajo (ajustado de #FFCCCC)
                        else if (value >= 0) data.cell.styles.fillColor = '#FFCCCC'; // Muy Bajo (ajustado de #F8D7DA)
                    }
                }
            });
            currentY = doc.autoTable.previous.finalY + 20;

            // Gráfico de Barras Apiladas: Distribución de Niveles de Interés por Área
            const stackedBarHeight = 220; // Altura para este gráfico específico en PDF
            const levelsLabels = ['Muy Bajo', 'Bajo', 'Moderado', 'Alto', 'Muy Alto'];
            const stackedData = {
                labels: ETIQUETAS_CORTAS_GRAFICO,
                datasets: levelsLabels.map((level, levelIndex) => ({
                    label: level,
                    data: ETIQUETAS_CORTAS_GRAFICO.map(areaName => datosCalculadosGrupales.nivelesInteres[areaName][level]),
                    backgroundColor: levelsColors[levelIndex],
                    borderColor: 'white',
                    borderWidth: 1
                }))
            };

            await drawChartAndAddToPdf(
                'stackedBarChart', 
                'GRÁFICO: DISTRIBUCIÓN DE NIVELES DE INTERÉS POR ÁREA', 
                'bar', 
                stackedData,
                {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: {
                        x: { stacked: true, ticks: { font: { size: 9, family: 'Montserrat' } }, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'N° de Estudiantes', font: { size: 9, family: 'Montserrat' } },
                             ticks: { precision: 0, stepSize: 5, max: Math.max(35, datosCalculadosGrupales.totalEstudiantes + 5) }, // Max adaptativo
                             grid: { color: COLOR_GRIS_CLARO }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 9, family: 'Montserrat' }, boxWidth: 10 } },
                        title: { display: false }, tooltip: { enabled: false },
                        datalabels: { display: true, color: 'black', font: { size: 7 }, formatter: (value) => value > 0 ? value.toFixed(0) : '', anchor: 'center', align: 'center' }
                    }
                },
                40, currentY, doc.internal.pageSize.getWidth() - 80, stackedBarHeight // Ocupa todo el ancho
            );
            currentY += stackedBarHeight + 20; // Actualizar currentY después del gráfico


            // Recomendaciones Institucionales
            doc.setFillColor(COLOR_ROJO_CLARO); doc.roundedRect(40, currentY, doc.internal.pageSize.getWidth() - 80, 18, 3, 3, 'F');
            doc.setTextColor('#333'); doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('RECOMENDACIONES PARA LA INSTITUCIÓN', 50, currentY + 12);
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
            currentY += 25;

            // Actualizar contenido dinámico en recomendaciones
            const recomendacionesText = `Basado en los resultados del grupo, se recomienda:

ANÁLISIS DE RESULTADOS:
• El área dominante del grupo es ${datosCalculadosGrupales.areaMasPopular.nombre}, lo que sugiere una tendencia hacia carreras de este campo.
• Se observa una distribución [equilibrada/desigual] entre las diferentes áreas vocacionales.
• Las puntuaciones promedio indican [alto/moderado/bajo] nivel de definición vocacional.

ACCIONES SUGERIDAS:
1. ORIENTACIÓN FOCALIZADA: Organizar charlas con profesionales del área más popular, programar visitas a universidades con programas en estas áreas, invitar egresados que estudien carreras relacionadas.
2. FORTALECIMIENTO DE ÁREAS MINORITARIAS: Crear espacios de exploración para áreas menos populares, considerar que algunos estudiantes pueden necesitar más información, organizar ferias vocacionales que muestren diversidad de opciones.
3. SEGUIMIENTO PERSONALIZADO: Programar sesiones individuales con estudiantes indecisos, identificar estudiantes con puntuaciones muy bajas en todas las áreas, crear grupos de orientación según áreas de interés.
4. ARTICULACIÓN CON CURRÍCULO: Fortalecer asignaturas relacionadas con áreas populares, ofrecer electivas que permitan explorar diferentes campos, vincular proyectos académicos con carreras profesionales.
5. ALIANZAS ESTRATÉGICAS: Establecer convenios con universidades en áreas de mayor demanda, coordinar visitas académicas y jornadas de inmersión, conseguir material informativo actualizado sobre carreras.
6. INFORMACIÓN A PADRES: Socializar resultados en reunión de padres, proporcionar guías sobre cómo apoyar la decisión vocacional, ofrecer espacios de consulta familiar.

CALENDARIO SUGERIDO:
• Semana 1-2: Socialización de resultados individuales
• Semana 3-4: Charlas con profesionales por áreas
• Mes 2: Visitas universitarias
• Mes 3: Feria vocacional institucional
• Permanente: Seguimiento individual y grupal`;
            
            const recomendacionesLines = doc.splitTextToSize(recomendacionesText, doc.internal.pageSize.getWidth() - 100);
            doc.text(recomendacionesLines, 50, currentY);


            generateFooter(3, 4);

            // --- Página 4: Listado de Estudiantes por Área Dominante ---
            doc.addPage();
            generateHeader(4, 4);
            currentY = 100;

            // Listado de Estudiantes por Área Dominante
            doc.setFillColor(COLOR_AZUL); doc.roundedRect(40, currentY, doc.internal.pageSize.getWidth() - 80, 18, 3, 3, 'F');
            doc.setTextColor('white'); doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('LISTADO DE ESTUDIANTES POR ÁREA DOMINANTE', 50, currentY + 12);
            doc.setTextColor('#333'); doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
            currentY += 25;

            const estudiantesAgrupados = ETIQUETAS_CORTAS.reduce((acc, areaKey) => {
                acc[areaKey] = estudiantesFiltrados.filter(e => e.areaDominanteCorta === areaKey).sort((a,b) => a.nombre.localeCompare(b.nombre));
                return acc;
            }, {});

            let listBody = [];
            ETIQUETAS_CORTAS.forEach((areaKey, i) => {
                const areaNombreLargo = ETIQUETAS_AREAS[i];
                const estudiantesEnArea = estudiantesAgrupados[areaKey];
                if (estudiantesEnArea && estudiantesEnArea.length > 0) {
                    listBody.push([{ content: `${areaNombreLargo} (${estudiantesEnArea.length} estudiantes)`, colSpan: 3, styles: { fillColor: COLOR_GRIS_CLARO, fontStyle: 'bold', textColor: '#333' } }]);
                    estudiantesEnArea.forEach(est => {
                        listBody.push(['', est.nombre, est.puntuacionMaxima]);
                    });
                }
            });

            doc.autoTable({
                startY: currentY,
                head: [['Área Dominante', 'Nombre del Estudiante', 'Puntuación Máxima']],
                body: listBody,
                headStyles: { fillColor: COLOR_AZUL, font: 'helvetica', fontStyle: 'bold', fontSize: 8 },
                bodyStyles: { font: 'helvetica', fontSize: 8 },
                columnStyles: { 
                    0: { cellWidth: 80 }, 
                    1: { cellWidth: 200 },
                    2: { cellWidth: 70, halign: 'center' }
                },
                margin: { left: 45, right: 400 },
                theme: 'grid'
            });


            generateFooter(4, 4);

            doc.save(`Informe Grupal - ${colegioNombre}.pdf`);
            ocultarLoader();
            alert('¡Generación del Informe Grupal completada!');
        }


        // --- EVENTOS DE LA UI ---
        document.addEventListener('DOMContentLoaded', cargarDatosIniciales);
        
        selectorColegio.addEventListener('change', () => {
            const hasSelection = !!selectorColegio.value;
            btnConsultar.disabled = !hasSelection;
            selectorEstudiante.innerHTML = '<option value="">-- Consulta primero --</option>';
            selectorEstudiante.disabled = true;
            btnPdfUnico.disabled = true;
            btnPdfCompilado.disabled = true;
            btnPdfIndividualMultiple.disabled = true; 
            btnPdfGrupal.disabled = true; 
            informeContainer.innerHTML = '';
        });

        btnConsultar.addEventListener('click', () => {
            const dane = selectorColegio.value;
            if (!dane) return;
            estudiantesFiltrados = todosLosDatos.estudiantes.filter(est => est.dane == dane);
            selectorEstudiante.innerHTML = '<option value="">-- Selecciona un Estudiante --</option>';
            const hasStudents = estudiantesFiltrados.length > 0;
            if (hasStudents) {
                estudiantesFiltrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
                estudiantesFiltrados.forEach(est => selectorEstudiante.add(new Option(est.nombre, est.correo)));
                selectorEstudiante.disabled = false;
                btnPdfCompilado.disabled = false;
                btnPdfIndividualMultiple.disabled = false; 
                btnPdfGrupal.disabled = false; 
            } else {
                selectorEstudiante.innerHTML = '<option value="">No hay estudiantes</option>';
            }
        });

        selectorEstudiante.addEventListener('change', () => {
            const correo = selectorEstudiante.value;
            btnPdfUnico.disabled = !correo; 
            if (correo) {
                const estudiante = todosLosDatos.estudiantes.find(est => est.correo === correo);
                const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
                renderizarInformeEnPantalla(estudiante, colegioNombre);
            }
        });

        // Evento para "Informe PDF Único" (antes Descargar PDF)
        btnPdfUnico.addEventListener('click', async () => {
            const correo = selectorEstudiante.value;
            if (!correo) return;
            mostrarLoader('Generando PDF Único...');
            const estudiante = todosLosDatos.estudiantes.find(est => est.correo === correo);
            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
            
            renderizarInformeEnPantalla(estudiante, colegioNombre); 
            await new Promise(r => setTimeout(r, 150)); 

            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
            await generarPaginaPdf(doc, estudiante, colegioNombre); // Esperar la generación de la página
            doc.save(`Informe - ${estudiante.nombre}.pdf`); // Guardar aquí después de que el gráfico se haya incrustado
            ocultarLoader();
        });

        // Evento para "Informe PDF Compilado" (antes Descarga Masiva)
        btnPdfCompilado.addEventListener('click', async () => {
            if (estudiantesFiltrados.length === 0) return;
            if (!confirm(`Se generará un PDF compilado con ${estudiantesFiltrados.length} informes. ¿Continuar?`)) return;

            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });

            for (let i = 0; i < estudiantesFiltrados.length; i++) {
                const estudiante = estudiantesFiltrados[i];
                mostrarLoader(`Generando compilado (${i + 1}/${estudiantesFiltrados.length}): ${estudiante.nombre}`);
                
                renderizarInformeEnPantalla(estudiante, colegioNombre);
                await new Promise(r => setTimeout(r, 150));

                if (i > 0) doc.addPage();
                await generarPaginaPdf(doc, estudiante, colegioNombre); 
            }

            doc.save(`Informes Compilados - ${colegioNombre}.pdf`);
            ocultarLoader();
            alert('¡Generación compilada completada!');
        });

        // ¡NUEVO EVENTO! Para "Informe PDF Individual" (descarga múltiples archivos)
        btnPdfIndividualMultiple.addEventListener('click', async () => {
            if (estudiantesFiltrados.length === 0) return;
            if (!confirm(`Se generarán ${estudiantesFiltrados.length} archivos PDF individuales. ¿Continuar?`)) return;

            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;

            for (let i = 0; i < estudiantesFiltrados.length; i++) {
                const estudiante = estudiantesFiltrados[i];
                mostrarLoader(`Generando individual (${i + 1}/${estudiantesFiltrados.length}): ${estudiante.nombre}`);
                
                renderizarInformeEnPantalla(estudiante, colegioNombre);
                await new Promise(r => setTimeout(r, 150));

                const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
                await generarPaginaPdf(doc, estudiante, colegioNombre); 
                doc.save(`Informe - ${estudiante.nombre}.pdf`);
            }
            ocultarLoader();
            alert('¡Generación de PDFs individuales completada!');
        });


        // Evento para "Informe Grupal"
        btnPdfGrupal.addEventListener('click', async () => {
            const colegioNombre = selectorColegio.options[selectorColegio.selectedIndex].text;
            await generarPdfGrupal(colegioNombre);
        });
    </script>
</body>
</html>
